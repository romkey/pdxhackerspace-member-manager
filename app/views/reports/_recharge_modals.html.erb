<%# Single shared modal for linking users to Recharge payments %>
<div class="modal fade" id="linkRechargeUserModal" tabindex="-1" aria-labelledby="linkRechargeUserModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="linkRechargeUserModalLabel">Link User to Recharge Payment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="linkRechargeUserForm" method="post" data-turbo-frame="unmatched-recharge-frame">
        <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
        <input type="hidden" name="from_reports" value="true">
        <div class="modal-body">
          <p class="mb-3">Select a user to link to this Recharge payment. The user's <code>recharge_customer_id</code> will be set to match this payment's customer ID (<strong id="modalCustomerId"></strong>).</p>
          <div class="mb-3">
            <label for="recharge_user_search" class="form-label">Search Users</label>
            <input type="text" id="recharge_user_search" class="form-control" placeholder="Type at least 2 characters to search..." autocomplete="off">
            <div class="form-text">Search by name, email, or username</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Select User</label>
            <div id="recharge_user_results" class="border rounded" style="max-height: 300px; overflow-y: auto; display: none;">
            </div>
            <div id="recharge_user_loading" class="text-center p-3" style="display: none;">
              <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              Searching...
            </div>
            <div id="recharge_user_placeholder" class="text-muted text-center p-3 border rounded">
              Type to search for users
            </div>
            <div id="recharge_no_results" class="text-muted text-center p-3 border rounded" style="display: none;">
              No users found matching your search.
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" id="linkRechargeSubmit" disabled>Link User</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
(function() {
  const modal = document.getElementById('linkRechargeUserModal');
  const form = document.getElementById('linkRechargeUserForm');
  const searchInput = document.getElementById('recharge_user_search');
  const resultsContainer = document.getElementById('recharge_user_results');
  const loadingIndicator = document.getElementById('recharge_user_loading');
  const placeholder = document.getElementById('recharge_user_placeholder');
  const noResults = document.getElementById('recharge_no_results');
  const submitButton = document.getElementById('linkRechargeSubmit');
  const customerIdDisplay = document.getElementById('modalCustomerId');
  
  let searchTimeout = null;
  let selectedUserId = null;
  
  // Open modal with payment data
  window.openLinkRechargeModal = function(paymentId, customerId) {
    form.action = '/recharge_payments/' + paymentId + '/link_user';
    customerIdDisplay.textContent = customerId;
    selectedUserId = null;
    submitButton.disabled = true;
    searchInput.value = '';
    resultsContainer.style.display = 'none';
    resultsContainer.innerHTML = '';
    loadingIndicator.style.display = 'none';
    placeholder.style.display = 'block';
    noResults.style.display = 'none';
    
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();
  };
  
  // Search users via API
  function searchUsers(query) {
    if (query.length < 2) {
      resultsContainer.style.display = 'none';
      loadingIndicator.style.display = 'none';
      placeholder.style.display = 'block';
      noResults.style.display = 'none';
      return;
    }
    
    placeholder.style.display = 'none';
    loadingIndicator.style.display = 'block';
    resultsContainer.style.display = 'none';
    noResults.style.display = 'none';
    
    fetch('<%= api_users_search_path %>' + '?q=' + encodeURIComponent(query), {
      headers: {
        'Accept': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      }
    })
    .then(response => response.json())
    .then(users => {
      loadingIndicator.style.display = 'none';
      
      if (users.length === 0) {
        noResults.style.display = 'block';
        return;
      }
      
      resultsContainer.innerHTML = users.map(user => `
        <div class="user-item p-2 border-bottom" style="cursor: pointer;" data-user-id="${user.id}">
          <input type="radio" name="user_id" id="recharge_user_${user.id}" value="${user.id}" class="form-check-input me-2" required>
          <label for="recharge_user_${user.id}" class="form-check-label mb-0" style="cursor: pointer;">
            <strong>${escapeHtml(user.name)}</strong>
            ${user.email ? '<br><small class="text-muted">' + escapeHtml(user.email) + '</small>' : ''}
          </label>
        </div>
      `).join('');
      
      resultsContainer.style.display = 'block';
      
      // Add click handlers
      resultsContainer.querySelectorAll('.user-item').forEach(item => {
        item.addEventListener('click', function(e) {
          if (e.target.type !== 'radio') {
            const radio = item.querySelector('input[type="radio"]');
            if (radio) {
              radio.checked = true;
              selectedUserId = radio.value;
              submitButton.disabled = false;
              
              // Highlight selected
              resultsContainer.querySelectorAll('.user-item').forEach(i => i.classList.remove('bg-light'));
              item.classList.add('bg-light');
            }
          }
        });
        
        item.querySelector('input[type="radio"]').addEventListener('change', function() {
          selectedUserId = this.value;
          submitButton.disabled = false;
          resultsContainer.querySelectorAll('.user-item').forEach(i => i.classList.remove('bg-light'));
          item.classList.add('bg-light');
        });
      });
    })
    .catch(error => {
      console.error('Search error:', error);
      loadingIndicator.style.display = 'none';
      noResults.style.display = 'block';
      noResults.textContent = 'Error searching users. Please try again.';
    });
  }
  
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // Debounced search
  searchInput.addEventListener('input', function() {
    if (searchTimeout) clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => searchUsers(this.value.trim()), 300);
  });
  
  // Focus search on modal open
  modal.addEventListener('shown.bs.modal', function() {
    searchInput.focus();
  });
  
  // Close modal on successful turbo frame load
  document.addEventListener('turbo:frame-load', function(event) {
    if (event.target.id === 'unmatched-recharge-frame') {
      const modalInstance = bootstrap.Modal.getInstance(modal);
      if (modalInstance) {
        modalInstance.hide();
      }
    }
  });
})();
</script>
