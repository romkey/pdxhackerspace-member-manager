<div class="mb-4">
  <h1 class="h3 mb-1">Reports</h1>
  <p class="text-muted mb-0">Users requiring attention.</p>
</div>

<div class="card shadow-sm border-0 mb-4">
  <div class="card-body">
    <h2 class="h6 mb-3">Jump to Section</h2>
    <div class="d-flex flex-wrap gap-3">
      <%= link_to "#membership-status-unknown", class: "text-decoration-none" do %>
        <span class="badge text-bg-secondary fs-6 px-3 py-2">
          Membership Status: Unknown <span class="badge text-bg-light text-dark ms-2"><%= @membership_status_unknown.count %></span>
        </span>
      <% end %>
      <%= link_to "#payment-type-unknown", class: "text-decoration-none" do %>
        <span class="badge text-bg-secondary fs-6 px-3 py-2">
          Payment Type: Unknown <span class="badge text-bg-light text-dark ms-2"><%= @payment_type_unknown.count %></span>
        </span>
      <% end %>
      <%= link_to "#dues-status-unknown", class: "text-decoration-none" do %>
        <span class="badge text-bg-secondary fs-6 px-3 py-2">
          Dues Status: Unknown <span class="badge text-bg-light text-dark ms-2"><%= @dues_status_unknown.count %></span>
        </span>
      <% end %>
      <%= link_to "#dues-status-lapsed", class: "text-decoration-none" do %>
        <span class="badge text-bg-secondary fs-6 px-3 py-2">
          Dues Status: Lapsed <span class="badge text-bg-light text-dark ms-2"><%= @dues_status_lapsed.count %></span>
        </span>
      <% end %>
    </div>
  </div>
</div>

<!-- Membership Status Unknown -->
<div id="membership-status-unknown" class="card shadow-sm border-0 mb-4">
  <div class="card-header bg-body-tertiary">
    <h2 class="h5 mb-0">Membership Status: Unknown (<%= @membership_status_unknown.count %>)</h2>
  </div>
  <div class="card-body">
    <% if @membership_status_unknown.any? %>
      <div class="table-responsive">
        <table class="table mb-0 align-middle">
          <thead class="bg-body-tertiary">
            <tr>
              <th scope="col">Name</th>
              <th scope="col">Email</th>
              <th scope="col">Status</th>
              <th scope="col">Payment Type</th>
              <th scope="col">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @membership_status_unknown.each do |user| %>
              <tr>
                <td class="fw-semibold">
                  <%= link_to user.display_name, user_path(user), class: "text-decoration-none" %>
                </td>
                <td>
                  <% if user.email.present? %>
                    <%= mail_to user.email %>
                  <% else %>
                    <span class="text-muted fst-italic">Not provided</span>
                  <% end %>
                </td>
                <td>
                  <% badge_class = case user.membership_status
                     when "coworking" then "success"
                     when "basic" then "info"
                     when "guest" then "warning"
                     when "banned" then "danger"
                     when "deceased" then "dark"
                     when "sponsored" then "primary"
                     when "unknown" then "secondary"
                     else "secondary"
                     end %>
                  <span class="badge text-bg-<%= badge_class %>">
                    <%= user.membership_status.humanize %>
                  </span>
                  <% if user.active? %>
                    <span class="badge text-bg-success ms-1">Active</span>
                  <% end %>
                </td>
                <td>
                  <span class="badge text-bg-info"><%= user.payment_type.humanize %></span>
                </td>
                <td>
                  <div class="d-flex flex-wrap gap-1">
                    <%= link_to "Edit", edit_user_path(user), class: "btn btn-sm btn-outline-primary" %>
                    <% if user.active? %>
                      <%= button_to "Deactivate", reports_update_user_path(user_id: user.id, action_type: 'deactivate', anchor: 'membership-status-unknown'), method: :post, class: "btn btn-sm btn-outline-secondary", 
                          data: { 
                            turbo: false,
                            confirm_message: "Are you sure you want to deactivate #{user.display_name}?"
                          },
                          onclick: "return confirm(this.dataset.confirmMessage);" %>
                    <% else %>
                      <%= button_to "Activate", reports_update_user_path(user_id: user.id, action_type: 'activate', anchor: 'membership-status-unknown'), method: :post, class: "btn btn-sm btn-outline-success", 
                          data: { 
                            turbo: false,
                            confirm_message: "Are you sure you want to activate #{user.display_name}?"
                          },
                          onclick: "return confirm(this.dataset.confirmMessage);" %>
                    <% end %>
                    <%= button_to "Ban", reports_update_user_path(user_id: user.id, action_type: 'ban', anchor: 'membership-status-unknown'), method: :post, class: "btn btn-sm btn-outline-danger", 
                        data: { 
                          turbo: false,
                          confirm_message: "Are you sure you want to ban #{user.display_name}? This will set their membership status to 'banned' and deactivate them."
                        },
                        onclick: "return confirm(this.dataset.confirmMessage);" %>
                    <%= button_to "Deceased", reports_update_user_path(user_id: user.id, action_type: 'deceased', anchor: 'membership-status-unknown'), method: :post, class: "btn btn-sm btn-outline-dark", 
                        data: { 
                          turbo: false,
                          confirm_message: "Are you sure you want to mark #{user.display_name} as deceased? This will set their membership status to 'deceased' and deactivate them."
                        },
                        onclick: "return confirm(this.dataset.confirmMessage);" %>
                    <%= button_to "Basic", reports_update_user_path(user_id: user.id, action_type: 'basic', anchor: 'membership-status-unknown'), method: :post, class: "btn btn-sm btn-outline-info" %>
                    <%= button_to "Coworking", reports_update_user_path(user_id: user.id, action_type: 'coworking', anchor: 'membership-status-unknown'), method: :post, class: "btn btn-sm btn-outline-success" %>
                    <%= button_to "Sponsored", reports_update_user_path(user_id: user.id, action_type: 'sponsored', anchor: 'membership-status-unknown'), method: :post, class: "btn btn-sm btn-outline-primary" %>
                    <%= button_to "Guest", reports_update_user_path(user_id: user.id, action_type: 'guest', anchor: 'membership-status-unknown'), method: :post, class: "btn btn-sm btn-outline-warning" %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p class="text-muted mb-0">No users with unknown membership status.</p>
    <% end %>
  </div>
</div>

<!-- Payment Type Unknown -->
<div id="payment-type-unknown" class="card shadow-sm border-0 mb-4">
  <div class="card-header bg-body-tertiary">
    <h2 class="h5 mb-0">Payment Type: Unknown (<%= @payment_type_unknown.count %>)</h2>
  </div>
  <div class="card-body">
    <% if @payment_type_unknown.any? %>
      <div class="table-responsive">
        <table class="table mb-0 align-middle">
          <thead class="bg-body-tertiary">
            <tr>
              <th scope="col">Name</th>
              <th scope="col">Email</th>
              <th scope="col">Status</th>
              <th scope="col">Payment Type</th>
              <th scope="col">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @payment_type_unknown.each do |user| %>
              <tr>
                <td class="fw-semibold">
                  <%= link_to user.display_name, user_path(user), class: "text-decoration-none" %>
                </td>
                <td>
                  <% if user.email.present? %>
                    <%= mail_to user.email %>
                  <% else %>
                    <span class="text-muted fst-italic">Not provided</span>
                  <% end %>
                </td>
                <td>
                  <% badge_class = case user.membership_status
                     when "coworking" then "success"
                     when "basic" then "info"
                     when "guest" then "warning"
                     when "banned" then "danger"
                     when "deceased" then "dark"
                     when "sponsored" then "primary"
                     when "unknown" then "secondary"
                     else "secondary"
                     end %>
                  <span class="badge text-bg-<%= badge_class %>">
                    <%= user.membership_status.humanize %>
                  </span>
                  <% if user.active? %>
                    <span class="badge text-bg-success ms-1">Active</span>
                  <% end %>
                </td>
                <td>
                  <span class="badge text-bg-info"><%= user.payment_type.humanize %></span>
                </td>
                <td>
                  <div class="d-flex flex-wrap gap-1">
                    <%= link_to "Edit", edit_user_path(user), class: "btn btn-sm btn-outline-primary" %>
                    <% if user.active? %>
                      <%= button_to "Deactivate", reports_update_user_path(user_id: user.id, action_type: 'deactivate', anchor: 'payment-type-unknown'), method: :post, class: "btn btn-sm btn-outline-secondary", 
                          data: { 
                            turbo: false,
                            confirm_message: "Are you sure you want to deactivate #{user.display_name}?"
                          },
                          onclick: "return confirm(this.dataset.confirmMessage);" %>
                    <% else %>
                      <%= button_to "Activate", reports_update_user_path(user_id: user.id, action_type: 'activate', anchor: 'payment-type-unknown'), method: :post, class: "btn btn-sm btn-outline-success", 
                          data: { 
                            turbo: false,
                            confirm_message: "Are you sure you want to activate #{user.display_name}?"
                          },
                          onclick: "return confirm(this.dataset.confirmMessage);" %>
                    <% end %>
                    <%= button_to "Ban", reports_update_user_path(user_id: user.id, action_type: 'ban', anchor: 'payment-type-unknown'), method: :post, class: "btn btn-sm btn-outline-danger", 
                        data: { 
                          turbo: false,
                          confirm_message: "Are you sure you want to ban #{user.display_name}? This will set their membership status to 'banned' and deactivate them."
                        },
                        onclick: "return confirm(this.dataset.confirmMessage);" %>
                    <%= button_to "Cash", reports_update_user_path(user_id: user.id, action_type: 'cash', anchor: 'payment-type-unknown'), method: :post, class: "btn btn-sm btn-outline-secondary" %>
                    <%= button_to "PayPal", reports_update_user_path(user_id: user.id, action_type: 'paypal', anchor: 'payment-type-unknown'), method: :post, class: "btn btn-sm btn-outline-secondary" %>
                    <%= button_to "Recharge", reports_update_user_path(user_id: user.id, action_type: 'recharge', anchor: 'payment-type-unknown'), method: :post, class: "btn btn-sm btn-outline-secondary" %>
                    <%= button_to "Guest", reports_update_user_path(user_id: user.id, action_type: 'guest', anchor: 'payment-type-unknown'), method: :post, class: "btn btn-sm btn-outline-secondary" %>
                    <%= button_to "Sponsored", reports_update_user_path(user_id: user.id, action_type: 'sponsored', anchor: 'payment-type-unknown'), method: :post, class: "btn btn-sm btn-outline-secondary" %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p class="text-muted mb-0">No users with unknown payment type.</p>
    <% end %>
  </div>
</div>

<!-- Dues Status Unknown -->
<div id="dues-status-unknown" class="card shadow-sm border-0 mb-4">
  <div class="card-header bg-body-tertiary">
    <h2 class="h5 mb-0">Dues Status: Unknown (<%= @dues_status_unknown.count %>)</h2>
  </div>
  <div class="card-body">
    <% if @dues_status_unknown.any? %>
      <div class="table-responsive">
        <table class="table mb-0 align-middle">
          <thead class="bg-body-tertiary">
            <tr>
              <th scope="col">Name</th>
              <th scope="col">Email</th>
              <th scope="col">Status</th>
              <th scope="col">Dues Status</th>
              <th scope="col">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @dues_status_unknown.each do |user| %>
              <tr>
                <td class="fw-semibold">
                  <%= link_to user.display_name, user_path(user), class: "text-decoration-none" %>
                </td>
                <td>
                  <% if user.email.present? %>
                    <%= mail_to user.email %>
                  <% else %>
                    <span class="text-muted fst-italic">Not provided</span>
                  <% end %>
                </td>
                <td>
                  <% badge_class = case user.membership_status
                     when "coworking" then "success"
                     when "basic" then "info"
                     when "guest" then "warning"
                     when "banned" then "danger"
                     when "deceased" then "dark"
                     when "sponsored" then "primary"
                     when "unknown" then "secondary"
                     else "secondary"
                     end %>
                  <span class="badge text-bg-<%= badge_class %>">
                    <%= user.membership_status.humanize %>
                  </span>
                  <% if user.active? %>
                    <span class="badge text-bg-success ms-1">Active</span>
                  <% end %>
                </td>
                <td>
                  <% dues_badge_class = case user.dues_status
                     when "current" then "success"
                     when "lapsed" then "warning"
                     when "inactive" then "secondary"
                     when "unknown" then "secondary"
                     else "secondary"
                     end %>
                  <span class="badge text-bg-<%= dues_badge_class %>"><%= user.dues_status.humanize %></span>
                </td>
                <td>
                  <div class="d-flex flex-wrap gap-1">
                    <%= link_to "Edit", edit_user_path(user), class: "btn btn-sm btn-outline-primary" %>
                    <% if user.active? %>
                      <%= button_to "Deactivate", reports_update_user_path(user_id: user.id, action_type: 'deactivate', anchor: 'dues-status-unknown'), method: :post, class: "btn btn-sm btn-outline-secondary", 
                          data: { 
                            turbo: false,
                            confirm_message: "Are you sure you want to deactivate #{user.display_name}?"
                          },
                          onclick: "return confirm(this.dataset.confirmMessage);" %>
                    <% else %>
                      <%= button_to "Activate", reports_update_user_path(user_id: user.id, action_type: 'activate', anchor: 'dues-status-unknown'), method: :post, class: "btn btn-sm btn-outline-success", 
                          data: { 
                            turbo: false,
                            confirm_message: "Are you sure you want to activate #{user.display_name}?"
                          },
                          onclick: "return confirm(this.dataset.confirmMessage);" %>
                    <% end %>
                    <%= button_to "Ban", reports_update_user_path(user_id: user.id, action_type: 'ban', anchor: 'dues-status-unknown'), method: :post, class: "btn btn-sm btn-outline-danger", 
                        data: { 
                          turbo: false,
                          confirm_message: "Are you sure you want to ban #{user.display_name}? This will set their membership status to 'banned' and deactivate them."
                        },
                        onclick: "return confirm(this.dataset.confirmMessage);" %>
                    <%= button_to "Deceased", reports_update_user_path(user_id: user.id, action_type: 'deceased', anchor: 'dues-status-unknown'), method: :post, class: "btn btn-sm btn-outline-dark", 
                        data: { 
                          turbo: false,
                          confirm_message: "Are you sure you want to mark #{user.display_name} as deceased? This will set their membership status to 'deceased' and deactivate them."
                        },
                        onclick: "return confirm(this.dataset.confirmMessage);" %>
                    <%= button_to "Basic", reports_update_user_path(user_id: user.id, action_type: 'basic', anchor: 'dues-status-unknown'), method: :post, class: "btn btn-sm btn-outline-info" %>
                    <%= button_to "Coworking", reports_update_user_path(user_id: user.id, action_type: 'coworking', anchor: 'dues-status-unknown'), method: :post, class: "btn btn-sm btn-outline-success" %>
                    <%= button_to "Sponsored", reports_update_user_path(user_id: user.id, action_type: 'sponsored', anchor: 'dues-status-unknown'), method: :post, class: "btn btn-sm btn-outline-primary" %>
                    <%= button_to "Guest", reports_update_user_path(user_id: user.id, action_type: 'guest', anchor: 'dues-status-unknown'), method: :post, class: "btn btn-sm btn-outline-warning" %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p class="text-muted mb-0">No users with unknown dues status.</p>
    <% end %>
  </div>
</div>

<!-- Dues Status Lapsed -->
<div id="dues-status-lapsed" class="card shadow-sm border-0 mb-4">
  <div class="card-header bg-body-tertiary">
    <h2 class="h5 mb-0">Dues Status: Lapsed (<%= @dues_status_lapsed.count %>)</h2>
  </div>
  <div class="card-body">
    <% if @dues_status_lapsed.any? %>
      <div class="table-responsive">
        <table class="table mb-0 align-middle">
          <thead class="bg-body-tertiary">
            <tr>
              <th scope="col">Name</th>
              <th scope="col">Email</th>
              <th scope="col">Status</th>
              <th scope="col">Dues Status</th>
              <th scope="col">Last Payment</th>
              <th scope="col">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @dues_status_lapsed.each do |user| %>
              <tr>
                <td class="fw-semibold">
                  <%= link_to user.display_name, user_path(user), class: "text-decoration-none" %>
                </td>
                <td>
                  <% if user.email.present? %>
                    <%= mail_to user.email %>
                  <% else %>
                    <span class="text-muted fst-italic">Not provided</span>
                  <% end %>
                </td>
                <td>
                  <% badge_class = case user.membership_status
                     when "coworking" then "success"
                     when "basic" then "info"
                     when "guest" then "warning"
                     when "banned" then "danger"
                     when "deceased" then "dark"
                     when "sponsored" then "primary"
                     when "unknown" then "secondary"
                     else "secondary"
                     end %>
                  <span class="badge text-bg-<%= badge_class %>">
                    <%= user.membership_status.humanize %>
                  </span>
                  <% if user.active? %>
                    <span class="badge text-bg-success ms-1">Active</span>
                  <% end %>
                </td>
                <td>
                  <span class="badge text-bg-warning"><%= user.dues_status.humanize %></span>
                </td>
                <td>
                  <% if user.last_payment_date.present? %>
                    <%= l(user.last_payment_date, format: :long) %>
                  <% else %>
                    <span class="text-muted fst-italic">Never</span>
                  <% end %>
                </td>
                <td>
                  <div class="d-flex flex-wrap gap-1">
                    <%= link_to "Edit", edit_user_path(user), class: "btn btn-sm btn-outline-primary" %>
                    <% if user.active? %>
                      <%= button_to "Deactivate", reports_update_user_path(user_id: user.id, action_type: 'deactivate', anchor: 'dues-status-lapsed'), method: :post, class: "btn btn-sm btn-outline-secondary", 
                          data: { 
                            turbo: false,
                            confirm_message: "Are you sure you want to deactivate #{user.display_name}?"
                          },
                          onclick: "return confirm(this.dataset.confirmMessage);" %>
                    <% else %>
                      <%= button_to "Activate", reports_update_user_path(user_id: user.id, action_type: 'activate', anchor: 'dues-status-lapsed'), method: :post, class: "btn btn-sm btn-outline-success", 
                          data: { 
                            turbo: false,
                            confirm_message: "Are you sure you want to activate #{user.display_name}?"
                          },
                          onclick: "return confirm(this.dataset.confirmMessage);" %>
                    <% end %>
                    <%= button_to "Ban", reports_update_user_path(user_id: user.id, action_type: 'ban', anchor: 'dues-status-lapsed'), method: :post, class: "btn btn-sm btn-outline-danger", 
                        data: { 
                          turbo: false,
                          confirm_message: "Are you sure you want to ban #{user.display_name}? This will set their membership status to 'banned' and deactivate them."
                        },
                        onclick: "return confirm(this.dataset.confirmMessage);" %>
                    <%= button_to "Deceased", reports_update_user_path(user_id: user.id, action_type: 'deceased', anchor: 'dues-status-lapsed'), method: :post, class: "btn btn-sm btn-outline-dark", 
                        data: { 
                          turbo: false,
                          confirm_message: "Are you sure you want to mark #{user.display_name} as deceased? This will set their membership status to 'deceased' and deactivate them."
                        },
                        onclick: "return confirm(this.dataset.confirmMessage);" %>
                    <%= button_to "Basic", reports_update_user_path(user_id: user.id, action_type: 'basic', anchor: 'dues-status-lapsed'), method: :post, class: "btn btn-sm btn-outline-info" %>
                    <%= button_to "Coworking", reports_update_user_path(user_id: user.id, action_type: 'coworking', anchor: 'dues-status-lapsed'), method: :post, class: "btn btn-sm btn-outline-success" %>
                    <%= button_to "Sponsored", reports_update_user_path(user_id: user.id, action_type: 'sponsored', anchor: 'dues-status-lapsed'), method: :post, class: "btn btn-sm btn-outline-primary" %>
                    <%= button_to "Guest", reports_update_user_path(user_id: user.id, action_type: 'guest', anchor: 'dues-status-lapsed'), method: :post, class: "btn btn-sm btn-outline-warning" %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p class="text-muted mb-0">No users with lapsed dues status.</p>
    <% end %>
  </div>
</div>

<!-- Floating back to top button -->
<%= link_to "#", class: "position-fixed bottom-0 end-0 m-4 text-decoration-none", style: "z-index: 1000;", title: "Back to top" do %>
  <div class="bg-primary text-white rounded-circle p-3 shadow-lg">
    <i class="bi bi-arrow-up-circle fs-4"></i>
  </div>
<% end %>
