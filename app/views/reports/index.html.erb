<div class="mb-4">
  <h1 class="h3 mb-1">Reports</h1>
  <p class="text-muted mb-0">Users requiring attention.</p>
</div>

<% 
  active_tab = params[:tab] || 'charts'
  tabs = [
    { id: 'charts', name: 'Charts', count: nil },
    { id: 'membership-status-unknown', name: 'Membership', count: @membership_status_unknown_count },
    { id: 'payment-type-unknown', name: 'Payment', count: @payment_type_unknown_count },
    { id: 'dues-status-unknown', name: 'Dues', count: @dues_status_unknown_count },
    { id: 'dues-status-lapsed', name: 'Lapsed', count: @dues_status_lapsed_count },
    { id: 'unmatched-paypal', name: 'PayPal', count: @unmatched_paypal_payments_count },
    { id: 'unmatched-recharge', name: 'Recharge', count: @unmatched_recharge_payments_count }
  ]
%>

<ul class="nav nav-tabs mb-4" role="tablist">
  <% tabs.each do |tab| %>
    <li class="nav-item" role="presentation">
      <button class="nav-link <%= 'active' if active_tab == tab[:id] %>" 
              id="<%= tab[:id] %>-tab" 
              data-bs-toggle="tab" 
              data-bs-target="#<%= tab[:id] %>-pane" 
              type="button" 
              role="tab" 
              aria-controls="<%= tab[:id] %>-pane" 
              aria-selected="<%= active_tab == tab[:id] %>">
        <%= tab[:name] %> <span class="badge text-bg-secondary ms-1"><%= tab[:count] %></span>
      </button>
    </li>
  <% end %>
</ul>

<div class="tab-content">
  <!-- Charts -->
  <div class="tab-pane fade <%= 'show active' if active_tab == 'charts' %>" 
       id="charts-pane" 
       role="tabpanel" 
       aria-labelledby="charts-tab">
    <div class="row g-4">
      <!-- Active Members Chart -->
      <div class="col-12">
        <div class="card shadow-sm border-0">
          <div class="card-header bg-body-tertiary">
            <h2 class="h5 mb-0">Active Members per Month</h2>
          </div>
          <div class="card-body">
            <canvas id="activeMembersChart" height="80"></canvas>
          </div>
        </div>
      </div>
      
      <!-- Revenue Chart -->
      <div class="col-12">
        <div class="card shadow-sm border-0">
          <div class="card-header bg-body-tertiary">
            <h2 class="h5 mb-0">Revenue per Month</h2>
          </div>
          <div class="card-body">
            <canvas id="revenueChart" height="80"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Membership Status Unknown -->
  <div class="tab-pane fade <%= 'show active' if active_tab == 'membership-status-unknown' %>" 
       id="membership-status-unknown-pane" 
       role="tabpanel" 
       aria-labelledby="membership-status-unknown-tab">
    <div class="card shadow-sm border-0">
      <div class="card-header bg-body-tertiary">
        <h2 class="h5 mb-0">Membership Status: Unknown (<%= @membership_status_unknown_count %>)</h2>
      </div>
      <div class="card-body">
        <% if @membership_status_unknown.any? %>
          <%= render partial: 'user_table', locals: { 
            users: @membership_status_unknown, 
            anchor: 'membership-status-unknown',
            show_payment_type: true,
            show_dues_status: false,
            show_last_payment: false
          } %>
          <% if @membership_status_unknown_count > 20 %>
            <div class="mt-3 text-center">
              <%= link_to "View all #{@membership_status_unknown_count} users", 
                  reports_view_all_path('membership-status-unknown'), 
                  class: "btn btn-outline-primary" %>
            </div>
          <% end %>
        <% else %>
          <p class="text-muted mb-0">No users with unknown membership status.</p>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Payment Type Unknown -->
  <div class="tab-pane fade <%= 'show active' if active_tab == 'payment-type-unknown' %>" 
       id="payment-type-unknown-pane" 
       role="tabpanel" 
       aria-labelledby="payment-type-unknown-tab">
    <div class="card shadow-sm border-0">
      <div class="card-header bg-body-tertiary">
        <h2 class="h5 mb-0">Payment Type: Unknown (<%= @payment_type_unknown_count %>)</h2>
      </div>
      <div class="card-body">
        <% if @payment_type_unknown.any? %>
          <%= render partial: 'user_table', locals: { 
            users: @payment_type_unknown, 
            anchor: 'payment-type-unknown',
            show_payment_type: true,
            show_dues_status: false,
            show_last_payment: false
          } %>
          <% if @payment_type_unknown_count > 20 %>
            <div class="mt-3 text-center">
              <%= link_to "View all #{@payment_type_unknown_count} users", 
                  reports_view_all_path('payment-type-unknown'), 
                  class: "btn btn-outline-primary" %>
            </div>
          <% end %>
        <% else %>
          <p class="text-muted mb-0">No users with unknown payment type.</p>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Dues Status Unknown -->
  <div class="tab-pane fade <%= 'show active' if active_tab == 'dues-status-unknown' %>" 
       id="dues-status-unknown-pane" 
       role="tabpanel" 
       aria-labelledby="dues-status-unknown-tab">
    <div class="card shadow-sm border-0">
      <div class="card-header bg-body-tertiary">
        <h2 class="h5 mb-0">Dues Status: Unknown (<%= @dues_status_unknown_count %>)</h2>
      </div>
      <div class="card-body">
        <% if @dues_status_unknown.any? %>
          <%= render partial: 'user_table', locals: { 
            users: @dues_status_unknown, 
            anchor: 'dues-status-unknown',
            show_payment_type: false,
            show_dues_status: true,
            show_last_payment: false
          } %>
          <% if @dues_status_unknown_count > 20 %>
            <div class="mt-3 text-center">
              <%= link_to "View all #{@dues_status_unknown_count} users", 
                  reports_view_all_path('dues-status-unknown'), 
                  class: "btn btn-outline-primary" %>
            </div>
          <% end %>
        <% else %>
          <p class="text-muted mb-0">No users with unknown dues status.</p>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Dues Status Lapsed -->
  <div class="tab-pane fade <%= 'show active' if active_tab == 'dues-status-lapsed' %>" 
       id="dues-status-lapsed-pane" 
       role="tabpanel" 
       aria-labelledby="dues-status-lapsed-tab">
    <div class="card shadow-sm border-0">
      <div class="card-header bg-body-tertiary">
        <h2 class="h5 mb-0">Dues Status: Lapsed (<%= @dues_status_lapsed_count %>)</h2>
      </div>
      <div class="card-body">
        <% if @dues_status_lapsed.any? %>
          <%= render partial: 'user_table', locals: { 
            users: @dues_status_lapsed, 
            anchor: 'dues-status-lapsed',
            show_payment_type: false,
            show_dues_status: true,
            show_last_payment: true
          } %>
          <% if @dues_status_lapsed_count > 20 %>
            <div class="mt-3 text-center">
              <%= link_to "View all #{@dues_status_lapsed_count} users", 
                  reports_view_all_path('dues-status-lapsed'), 
                  class: "btn btn-outline-primary" %>
            </div>
          <% end %>
        <% else %>
          <p class="text-muted mb-0">No users with lapsed dues status.</p>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Unmatched PayPal Payments -->
  <div class="tab-pane fade <%= 'show active' if active_tab == 'unmatched-paypal' %>" 
       id="unmatched-paypal-pane" 
       role="tabpanel" 
       aria-labelledby="unmatched-paypal-tab">
    <%= turbo_frame_tag "unmatched-paypal-frame", data: { turbo_action: "advance" } do %>
      <div class="card shadow-sm border-0">
        <div class="card-header bg-body-tertiary">
          <h2 class="h5 mb-0">Unmatched PayPal Payments (<%= @unmatched_paypal_payments_count %>)</h2>
        </div>
        <div class="card-body">
          <% if @unmatched_paypal_payments.any? %>
            <p class="text-muted small mb-3">Payments that don't have a matching User record by PayPal account ID</p>
            <%= render partial: 'paypal_payments_table', locals: { payments: @unmatched_paypal_payments } %>
            <% if @unmatched_paypal_payments_count > 20 %>
              <div class="mt-3 text-center">
                <%= link_to "View all #{@unmatched_paypal_payments_count} payments", 
                    reports_view_all_path('unmatched-paypal'), 
                    class: "btn btn-outline-primary" %>
              </div>
            <% end %>
          <% else %>
            <p class="text-muted mb-0">All PayPal payments have matching User records.</p>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Unmatched Recharge Payments -->
  <div class="tab-pane fade <%= 'show active' if active_tab == 'unmatched-recharge' %>" 
       id="unmatched-recharge-pane" 
       role="tabpanel" 
       aria-labelledby="unmatched-recharge-tab">
    <%= turbo_frame_tag "unmatched-recharge-frame", data: { turbo_action: "advance" } do %>
      <div class="card shadow-sm border-0">
        <div class="card-header bg-body-tertiary">
          <h2 class="h5 mb-0">Unmatched Recharge Payments (<%= @unmatched_recharge_payments_count %>)</h2>
        </div>
        <div class="card-body">
          <% if @unmatched_recharge_payments.any? %>
            <p class="text-muted small mb-3">Payments that don't have a matching User record by Recharge customer ID</p>
            <%= render partial: 'recharge_payments_table', locals: { payments: @unmatched_recharge_payments } %>
            <% if @unmatched_recharge_payments_count > 20 %>
              <div class="mt-3 text-center">
                <%= link_to "View all #{@unmatched_recharge_payments_count} payments", 
                    reports_view_all_path('unmatched-recharge'), 
                    class: "btn btn-outline-primary" %>
              </div>
            <% end %>
          <% else %>
            <p class="text-muted mb-0">All Recharge payments have matching User records.</p>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<%= render partial: 'paypal_modals', locals: { payments: @unmatched_paypal_payments } %>
<%= render partial: 'recharge_modals', locals: { payments: @unmatched_recharge_payments } %>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  // Update URL when tab changes
  document.addEventListener('DOMContentLoaded', function() {
    const tabButtons = document.querySelectorAll('[data-bs-toggle="tab"]');
    tabButtons.forEach(function(button) {
      button.addEventListener('shown.bs.tab', function(event) {
        const tabId = event.target.getAttribute('data-bs-target').replace('#', '').replace('-pane', '');
        const url = new URL(window.location);
        url.searchParams.set('tab', tabId);
        window.history.pushState({}, '', url);
        
        // Initialize charts when charts tab is shown
        if (tabId === 'charts') {
          initializeCharts();
        }
      });
    });
    
    // Set active tab from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const tabParam = urlParams.get('tab') || 'charts';
    const tabButton = document.querySelector('[data-bs-target="#' + tabParam + '-pane"]');
    if (tabButton) {
      const tab = new bootstrap.Tab(tabButton);
      tab.show();
      
      // Initialize charts if charts tab is active
      if (tabParam === 'charts') {
        setTimeout(initializeCharts, 100);
      }
    } else {
      // Default to charts tab
      const chartsTab = document.querySelector('[data-bs-target="#charts-pane"]');
      if (chartsTab) {
        const tab = new bootstrap.Tab(chartsTab);
        tab.show();
        setTimeout(initializeCharts, 100);
      }
    }
  });
  
  function initializeCharts() {
    // Active Members Chart
    const activeMembersCtx = document.getElementById('activeMembersChart');
    if (activeMembersCtx && typeof Chart !== 'undefined') {
      new Chart(activeMembersCtx, {
        type: 'line',
        data: {
          labels: <%= raw @chart_months.to_json %>,
          datasets: [{
            label: 'Active Members',
            data: <%= raw @active_members_counts.to_json %>,
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: true,
              position: 'top'
            },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });
    }
    
    // Revenue Chart
    const revenueCtx = document.getElementById('revenueChart');
    if (revenueCtx && typeof Chart !== 'undefined') {
      new Chart(revenueCtx, {
        type: 'bar',
        data: {
          labels: <%= raw @chart_months.to_json %>,
          datasets: [
            {
              label: 'PayPal',
              data: <%= raw @paypal_revenue.to_json %>,
              backgroundColor: 'rgba(0, 123, 255, 0.8)',
              borderColor: 'rgb(0, 123, 255)',
              borderWidth: 1
            },
            {
              label: 'Recharge',
              data: <%= raw @recharge_revenue.to_json %>,
              backgroundColor: 'rgba(40, 167, 69, 0.8)',
              borderColor: 'rgb(40, 167, 69)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: true,
              position: 'top'
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                }
              }
            }
          },
          scales: {
            x: {
              stacked: false
            },
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '$' + value.toFixed(0);
                }
              }
            }
          }
        }
      });
    }
  }
</script>
