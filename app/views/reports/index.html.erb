<div class="mb-4">
  <h1 class="h3 mb-1">Reports</h1>
  <p class="text-muted mb-0">Users requiring attention.</p>
</div>

<% 
  active_tab = params[:tab] || 'membership-status-unknown'
  tabs = [
    { id: 'membership-status-unknown', name: 'Membership', count: @membership_status_unknown_count },
    { id: 'payment-type-unknown', name: 'Payment', count: @payment_type_unknown_count },
    { id: 'dues-status-unknown', name: 'Dues', count: @dues_status_unknown_count },
    { id: 'dues-status-lapsed', name: 'Lapsed', count: @dues_status_lapsed_count },
    { id: 'unmatched-paypal', name: 'PayPal', count: @unmatched_paypal_payments_count },
    { id: 'unmatched-recharge', name: 'Recharge', count: @unmatched_recharge_payments_count }
  ]
%>

<ul class="nav nav-tabs mb-4" role="tablist">
  <% tabs.each do |tab| %>
    <li class="nav-item" role="presentation">
      <button class="nav-link <%= 'active' if active_tab == tab[:id] %>" 
              id="<%= tab[:id] %>-tab" 
              data-bs-toggle="tab" 
              data-bs-target="#<%= tab[:id] %>-pane" 
              type="button" 
              role="tab" 
              aria-controls="<%= tab[:id] %>-pane" 
              aria-selected="<%= active_tab == tab[:id] %>">
        <%= tab[:name] %> <span class="badge text-bg-secondary ms-1"><%= tab[:count] %></span>
      </button>
    </li>
  <% end %>
</ul>

<div class="tab-content">
  <!-- Membership Status Unknown -->
  <div class="tab-pane fade <%= 'show active' if active_tab == 'membership-status-unknown' %>" 
       id="membership-status-unknown-pane" 
       role="tabpanel" 
       aria-labelledby="membership-status-unknown-tab">
    <div class="card shadow-sm border-0">
      <div class="card-header bg-body-tertiary">
        <h2 class="h5 mb-0">Membership Status: Unknown (<%= @membership_status_unknown_count %>)</h2>
      </div>
      <div class="card-body">
        <% if @membership_status_unknown.any? %>
          <%= render partial: 'user_table', locals: { 
            users: @membership_status_unknown, 
            anchor: 'membership-status-unknown',
            show_payment_type: true,
            show_dues_status: false,
            show_last_payment: false
          } %>
          <% if @membership_status_unknown_count > 20 %>
            <div class="mt-3 text-center">
              <%= link_to "View all #{@membership_status_unknown_count} users", 
                  reports_view_all_path('membership-status-unknown'), 
                  class: "btn btn-outline-primary" %>
            </div>
          <% end %>
        <% else %>
          <p class="text-muted mb-0">No users with unknown membership status.</p>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Payment Type Unknown -->
  <div class="tab-pane fade <%= 'show active' if active_tab == 'payment-type-unknown' %>" 
       id="payment-type-unknown-pane" 
       role="tabpanel" 
       aria-labelledby="payment-type-unknown-tab">
    <div class="card shadow-sm border-0">
      <div class="card-header bg-body-tertiary">
        <h2 class="h5 mb-0">Payment Type: Unknown (<%= @payment_type_unknown_count %>)</h2>
      </div>
      <div class="card-body">
        <% if @payment_type_unknown.any? %>
          <%= render partial: 'user_table', locals: { 
            users: @payment_type_unknown, 
            anchor: 'payment-type-unknown',
            show_payment_type: true,
            show_dues_status: false,
            show_last_payment: false
          } %>
          <% if @payment_type_unknown_count > 20 %>
            <div class="mt-3 text-center">
              <%= link_to "View all #{@payment_type_unknown_count} users", 
                  reports_view_all_path('payment-type-unknown'), 
                  class: "btn btn-outline-primary" %>
            </div>
          <% end %>
        <% else %>
          <p class="text-muted mb-0">No users with unknown payment type.</p>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Dues Status Unknown -->
  <div class="tab-pane fade <%= 'show active' if active_tab == 'dues-status-unknown' %>" 
       id="dues-status-unknown-pane" 
       role="tabpanel" 
       aria-labelledby="dues-status-unknown-tab">
    <div class="card shadow-sm border-0">
      <div class="card-header bg-body-tertiary">
        <h2 class="h5 mb-0">Dues Status: Unknown (<%= @dues_status_unknown_count %>)</h2>
      </div>
      <div class="card-body">
        <% if @dues_status_unknown.any? %>
          <%= render partial: 'user_table', locals: { 
            users: @dues_status_unknown, 
            anchor: 'dues-status-unknown',
            show_payment_type: false,
            show_dues_status: true,
            show_last_payment: false
          } %>
          <% if @dues_status_unknown_count > 20 %>
            <div class="mt-3 text-center">
              <%= link_to "View all #{@dues_status_unknown_count} users", 
                  reports_view_all_path('dues-status-unknown'), 
                  class: "btn btn-outline-primary" %>
            </div>
          <% end %>
        <% else %>
          <p class="text-muted mb-0">No users with unknown dues status.</p>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Dues Status Lapsed -->
  <div class="tab-pane fade <%= 'show active' if active_tab == 'dues-status-lapsed' %>" 
       id="dues-status-lapsed-pane" 
       role="tabpanel" 
       aria-labelledby="dues-status-lapsed-tab">
    <div class="card shadow-sm border-0">
      <div class="card-header bg-body-tertiary">
        <h2 class="h5 mb-0">Dues Status: Lapsed (<%= @dues_status_lapsed_count %>)</h2>
      </div>
      <div class="card-body">
        <% if @dues_status_lapsed.any? %>
          <%= render partial: 'user_table', locals: { 
            users: @dues_status_lapsed, 
            anchor: 'dues-status-lapsed',
            show_payment_type: false,
            show_dues_status: true,
            show_last_payment: true
          } %>
          <% if @dues_status_lapsed_count > 20 %>
            <div class="mt-3 text-center">
              <%= link_to "View all #{@dues_status_lapsed_count} users", 
                  reports_view_all_path('dues-status-lapsed'), 
                  class: "btn btn-outline-primary" %>
            </div>
          <% end %>
        <% else %>
          <p class="text-muted mb-0">No users with lapsed dues status.</p>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Unmatched PayPal Payments -->
  <div class="tab-pane fade <%= 'show active' if active_tab == 'unmatched-paypal' %>" 
       id="unmatched-paypal-pane" 
       role="tabpanel" 
       aria-labelledby="unmatched-paypal-tab">
    <%= turbo_frame_tag "unmatched-paypal-frame", data: { turbo_action: "advance" } do %>
      <div class="card shadow-sm border-0">
        <div class="card-header bg-body-tertiary">
          <h2 class="h5 mb-0">Unmatched PayPal Payments (<%= @unmatched_paypal_payments_count %>)</h2>
        </div>
        <div class="card-body">
          <% if @unmatched_paypal_payments.any? %>
            <p class="text-muted small mb-3">Payments that don't have a matching User record by PayPal account ID</p>
            <%= render partial: 'paypal_payments_table', locals: { payments: @unmatched_paypal_payments } %>
            <% if @unmatched_paypal_payments_count > 20 %>
              <div class="mt-3 text-center">
                <%= link_to "View all #{@unmatched_paypal_payments_count} payments", 
                    reports_view_all_path('unmatched-paypal'), 
                    class: "btn btn-outline-primary" %>
              </div>
            <% end %>
          <% else %>
            <p class="text-muted mb-0">All PayPal payments have matching User records.</p>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Unmatched Recharge Payments -->
  <div class="tab-pane fade <%= 'show active' if active_tab == 'unmatched-recharge' %>" 
       id="unmatched-recharge-pane" 
       role="tabpanel" 
       aria-labelledby="unmatched-recharge-tab">
    <%= turbo_frame_tag "unmatched-recharge-frame", data: { turbo_action: "advance" } do %>
      <div class="card shadow-sm border-0">
        <div class="card-header bg-body-tertiary">
          <h2 class="h5 mb-0">Unmatched Recharge Payments (<%= @unmatched_recharge_payments_count %>)</h2>
        </div>
        <div class="card-body">
          <% if @unmatched_recharge_payments.any? %>
            <p class="text-muted small mb-3">Payments that don't have a matching User record by Recharge customer ID</p>
            <%= render partial: 'recharge_payments_table', locals: { payments: @unmatched_recharge_payments } %>
            <% if @unmatched_recharge_payments_count > 20 %>
              <div class="mt-3 text-center">
                <%= link_to "View all #{@unmatched_recharge_payments_count} payments", 
                    reports_view_all_path('unmatched-recharge'), 
                    class: "btn btn-outline-primary" %>
              </div>
            <% end %>
          <% else %>
            <p class="text-muted mb-0">All Recharge payments have matching User records.</p>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<%= render partial: 'paypal_modals', locals: { payments: @unmatched_paypal_payments } %>
<%= render partial: 'recharge_modals', locals: { payments: @unmatched_recharge_payments } %>

<script>
  // Update URL when tab changes
  document.addEventListener('DOMContentLoaded', function() {
    const tabButtons = document.querySelectorAll('[data-bs-toggle="tab"]');
    tabButtons.forEach(function(button) {
      button.addEventListener('shown.bs.tab', function(event) {
        const tabId = event.target.getAttribute('data-bs-target').replace('#', '').replace('-pane', '');
        const url = new URL(window.location);
        url.searchParams.set('tab', tabId);
        window.history.pushState({}, '', url);
      });
    });
    
    // Set active tab from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const tabParam = urlParams.get('tab');
    if (tabParam) {
      const tabButton = document.querySelector('[data-bs-target="#' + tabParam + '-pane"]');
      if (tabButton) {
        const tab = new bootstrap.Tab(tabButton);
        tab.show();
      }
    }
  });
</script>
