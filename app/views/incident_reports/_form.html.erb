<%= form_with model: @incident_report, local: true, class: "vstack gap-3" do |f| %>
  <div>
    <%= f.label :incident_date, "Date of Incident", class: "form-label" %>
    <%= f.date_field :incident_date, class: "form-control", required: true %>
  </div>

  <div>
    <%= f.label :subject, class: "form-label" %>
    <%= f.text_field :subject, class: "form-control", required: true, placeholder: "Brief summary of the incident" %>
  </div>

  <div>
    <%= f.label :incident_type, "Incident Type", class: "form-label" %>
    <%= f.select :incident_type, 
        options_for_select(IncidentReport::INCIDENT_TYPES, @incident_report.incident_type),
        { prompt: "Select a type..." },
        { class: "form-select", required: true, id: "incident_type_select" } %>
  </div>

  <div id="other_explanation_field" style="<%= 'display: none;' unless @incident_report.incident_type == 'other' %>">
    <%= f.label :other_type_explanation, "Please explain", class: "form-label" %>
    <%= f.text_field :other_type_explanation, class: "form-control", placeholder: "Describe the type of incident" %>
  </div>

  <div>
    <%= f.label :status, class: "form-label" %>
    <%= f.select :status, 
        options_for_select(IncidentReport::STATUSES, @incident_report.status),
        {},
        { class: "form-select" } %>
  </div>

  <div>
    <%= f.label :involved_member_ids, "Involved Members", class: "form-label" %>
    <div class="form-text mb-2">Select any members involved in this incident. Leave empty if only non-members were involved.</div>
    
    <!-- Selected members display -->
    <div id="selected_members" class="d-flex flex-wrap gap-2 mb-2">
      <% @incident_report.involved_members.each do |member| %>
        <span class="badge bg-primary d-flex align-items-center gap-1 selected-member-badge" data-user-id="<%= member.id %>">
          <%= member.display_name %>
          <button type="button" class="btn-close btn-close-white ms-1" style="font-size: 0.6rem;" aria-label="Remove"></button>
        </span>
      <% end %>
    </div>
    
    <!-- Hidden inputs for selected members -->
    <div id="selected_member_inputs">
      <% @incident_report.involved_members.each do |member| %>
        <input type="hidden" name="incident_report[involved_member_ids][]" value="<%= member.id %>" data-user-id="<%= member.id %>">
      <% end %>
    </div>
    
    <!-- Search input -->
    <div class="mb-2">
      <input type="text" id="member_search" class="form-control" placeholder="Type to search and add members..." autocomplete="off">
    </div>
    
    <!-- Search results dropdown -->
    <div id="member_search_results" class="border rounded" style="max-height: 200px; overflow-y: auto; display: none;">
      <% @users.each do |user| %>
        <div class="member-result p-2 border-bottom" 
             data-user-id="<%= user.id %>" 
             data-user-name="<%= user.display_name.downcase %>"
             data-user-display="<%= user.display_name %>"
             style="cursor: pointer;">
          <span class="member-name"><%= user.display_name %></span>
          <% if user.email.present? %>
            <span class="text-muted small ms-2"><%= user.email %></span>
          <% end %>
        </div>
      <% end %>
    </div>
    <div id="no_member_results" class="text-muted text-center p-3 border rounded" style="display: none;">
      No members found matching your search.
    </div>
  </div>

  <div>
    <%= f.label :description, class: "form-label" %>
    <%= f.text_area :description, class: "form-control", rows: 6, placeholder: "Detailed description of the incident..." %>
  </div>

  <div>
    <%= f.label :resolution, class: "form-label" %>
    <%= f.text_area :resolution, class: "form-control", rows: 4, placeholder: "How was this incident resolved? (Optional - can be filled in later)" %>
    <div class="form-text">Document any actions taken, outcomes, or follow-up required.</div>
  </div>

  <div>
    <%= f.label :photos, class: "form-label" %>
    <%= f.file_field :photos, multiple: true, class: "form-control", accept: "image/*" %>
    <div class="form-text">You can select multiple photos. Accepted formats: JPEG, PNG, GIF, WebP.</div>
    
    <% if @incident_report.photos.attached? %>
      <div class="mt-2">
        <strong>Current photos:</strong>
        <div class="d-flex flex-wrap gap-2 mt-2">
          <% @incident_report.photos.each do |photo| %>
            <div class="position-relative">
              <% if photo.content_type.start_with?('image/') %>
                <%= image_tag rails_blob_path(photo, disposition: 'inline'), 
                    class: "rounded", 
                    style: "max-width: 100px; max-height: 100px; object-fit: cover;" %>
              <% else %>
                <span class="badge text-bg-secondary"><%= photo.filename %></span>
              <% end %>
            </div>
          <% end %>
        </div>
        <div class="form-text mt-1">Note: Uploading new photos will add to existing ones.</div>
      </div>
    <% end %>
  </div>

  <div class="d-flex gap-2">
    <%= f.submit @incident_report.persisted? ? "Update" : "Create", class: "btn btn-primary" %>
    <%= link_to "Cancel", @incident_report.persisted? ? incident_report_path(@incident_report) : incident_reports_path, class: "btn btn-outline-secondary" %>
  </div>
<% end %>

<% if @incident_report.persisted? %>
  <!-- Links Section (outside main form to avoid nested forms) -->
  <div class="mt-4">
    <label class="form-label">Links</label>
    <div class="form-text mb-2">Add links to related documents, tickets, or external resources.</div>
    
    <% if @incident_report.links.any? %>
      <ul class="list-group mb-3">
        <% @incident_report.links.ordered.each do |link| %>
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <i class="bi bi-link-45deg text-muted me-1"></i>
              <%= link_to link.title, link.url, target: '_blank', rel: 'noopener', class: "text-decoration-none" %>
              <span class="text-muted small ms-2"><%= truncate(link.url, length: 50) %></span>
            </div>
            <%= button_to remove_link_incident_report_path(@incident_report, link_id: link.id), 
                method: :delete, 
                class: "btn btn-sm btn-outline-danger",
                data: { turbo_confirm: "Remove this link?" } do %>
              <i class="bi bi-trash"></i>
            <% end %>
          </li>
        <% end %>
      </ul>
    <% end %>

    <!-- Add Link Form -->
    <div class="card bg-body-tertiary">
      <div class="card-body">
        <h6 class="card-subtitle mb-2 text-muted">Add a new link</h6>
        <%= form_with url: add_link_incident_report_path(@incident_report), method: :post, local: true, class: "row g-2 align-items-end" do %>
          <div class="col-md-4">
            <label class="form-label small">Title</label>
            <input type="text" name="incident_report_link[title]" class="form-control form-control-sm" placeholder="Link title" required>
          </div>
          <div class="col-md-6">
            <label class="form-label small">URL</label>
            <input type="url" name="incident_report_link[url]" class="form-control form-control-sm" placeholder="https://..." required>
          </div>
          <div class="col-md-2">
            <button type="submit" class="btn btn-primary btn-sm w-100">Add Link</button>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Show/hide other explanation field based on incident type
    const typeSelect = document.getElementById('incident_type_select');
    const otherField = document.getElementById('other_explanation_field');

    if (typeSelect && otherField) {
      typeSelect.addEventListener('change', function() {
        if (this.value === 'other') {
          otherField.style.display = '';
        } else {
          otherField.style.display = 'none';
        }
      });
    }

    // Member search and selection functionality
    const memberSearch = document.getElementById('member_search');
    const searchResults = document.getElementById('member_search_results');
    const noResults = document.getElementById('no_member_results');
    const selectedMembers = document.getElementById('selected_members');
    const selectedInputs = document.getElementById('selected_member_inputs');

    if (!memberSearch || !searchResults || !selectedMembers || !selectedInputs) return;

    // Get currently selected member IDs
    function getSelectedIds() {
      const ids = new Set();
      selectedInputs.querySelectorAll('input[type="hidden"]').forEach(function(input) {
        ids.add(input.value);
      });
      return ids;
    }

    // Filter and show search results
    function filterMembers() {
      const searchTerm = memberSearch.value.toLowerCase().trim();
      const selectedIds = getSelectedIds();
      const results = searchResults.querySelectorAll('.member-result');
      let visibleCount = 0;

      if (searchTerm === '') {
        searchResults.style.display = 'none';
        noResults.style.display = 'none';
        return;
      }

      results.forEach(function(result) {
        const name = result.getAttribute('data-user-name');
        const userId = result.getAttribute('data-user-id');
        const isSelected = selectedIds.has(userId);
        
        if (!isSelected && name && name.includes(searchTerm)) {
          result.style.display = '';
          visibleCount++;
        } else {
          result.style.display = 'none';
        }
      });

      if (visibleCount === 0) {
        searchResults.style.display = 'none';
        noResults.style.display = 'block';
      } else {
        searchResults.style.display = 'block';
        noResults.style.display = 'none';
      }
    }

    // Add a member to the selection
    function addMember(userId, displayName) {
      // Check if already selected
      if (getSelectedIds().has(userId)) return;

      // Add hidden input
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'incident_report[involved_member_ids][]';
      input.value = userId;
      input.setAttribute('data-user-id', userId);
      selectedInputs.appendChild(input);

      // Add badge
      const badge = document.createElement('span');
      badge.className = 'badge bg-primary d-flex align-items-center gap-1 selected-member-badge';
      badge.setAttribute('data-user-id', userId);
      badge.innerHTML = displayName + 
        '<button type="button" class="btn-close btn-close-white ms-1" style="font-size: 0.6rem;" aria-label="Remove"></button>';
      selectedMembers.appendChild(badge);

      // Add click handler for remove button
      badge.querySelector('.btn-close').addEventListener('click', function() {
        removeMember(userId);
      });

      // Clear search and hide results
      memberSearch.value = '';
      searchResults.style.display = 'none';
      noResults.style.display = 'none';
    }

    // Remove a member from the selection
    function removeMember(userId) {
      // Remove hidden input
      const input = selectedInputs.querySelector('input[data-user-id="' + userId + '"]');
      if (input) input.remove();

      // Remove badge
      const badge = selectedMembers.querySelector('.selected-member-badge[data-user-id="' + userId + '"]');
      if (badge) badge.remove();
    }

    // Event listeners
    memberSearch.addEventListener('input', filterMembers);
    memberSearch.addEventListener('focus', filterMembers);

    // Click to add member from search results
    searchResults.querySelectorAll('.member-result').forEach(function(result) {
      result.addEventListener('click', function() {
        const userId = this.getAttribute('data-user-id');
        const displayName = this.getAttribute('data-user-display');
        addMember(userId, displayName);
      });

      // Hover effect
      result.addEventListener('mouseenter', function() {
        this.classList.add('bg-body-secondary');
      });
      result.addEventListener('mouseleave', function() {
        this.classList.remove('bg-body-secondary');
      });
    });

    // Remove member when clicking badge close button (for pre-existing selections)
    selectedMembers.querySelectorAll('.selected-member-badge .btn-close').forEach(function(btn) {
      btn.addEventListener('click', function() {
        const badge = this.closest('.selected-member-badge');
        const userId = badge.getAttribute('data-user-id');
        removeMember(userId);
      });
    });

    // Hide results when clicking outside
    document.addEventListener('click', function(e) {
      if (!memberSearch.contains(e.target) && !searchResults.contains(e.target)) {
        searchResults.style.display = 'none';
        noResults.style.display = 'none';
      }
    });

    // Keyboard navigation
    memberSearch.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        searchResults.style.display = 'none';
        noResults.style.display = 'none';
        memberSearch.blur();
      }
    });
  });
</script>
