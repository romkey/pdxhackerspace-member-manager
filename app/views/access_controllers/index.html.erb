<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h3 mb-1">Access Controllers</h1>
    <p class="text-muted mb-0">Manage access control devices for RFID key synchronization.</p>
  </div>
  <div class="d-flex gap-2">
    <%= link_to "New Access Controller", new_access_controller_path, class: "btn btn-primary" %>
    <%= button_to "Sync All", sync_all_access_controllers_path, method: :post, class: "btn btn-outline-primary", data: { turbo: false } %>
    <%= link_to "Back to Settings", settings_path, class: "btn btn-secondary" %>
  </div>
</div>

<% if @access_controllers.any? %>
  <div class="card shadow-sm border-0">
    <div class="table-responsive">
      <table class="table mb-0 align-middle">
        <thead class="bg-body-tertiary">
          <tr>
            <th scope="col">Name</th>
            <th scope="col">Hostname</th>
            <th scope="col">Type</th>
            <th scope="col">Status</th>
            <th scope="col">Last Sync</th>
            <th scope="col">Enabled</th>
            <th scope="col" class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% @access_controllers.each do |controller| %>
            <tr class="<%= 'text-body-secondary opacity-75' unless controller.enabled? %>">
              <td>
                <strong><%= controller.name %></strong>
                <% if controller.description.present? %>
                  <br><span class="text-muted small"><%= truncate(controller.description, length: 60) %></span>
                <% end %>
              </td>
              <td><code><%= controller.hostname %></code></td>
              <td>
                <% if controller.access_controller_type %>
                  <span class="badge text-bg-info"><%= controller.access_controller_type.name %></span>
                <% else %>
                  <span class="text-muted">â€”</span>
                <% end %>
              </td>
              <td>
                <span class="badge text-bg-<%= controller.status_badge_class %>">
                  <%= controller.status_label %>
                </span>
                <% if controller.last_sync_message.present? && controller.sync_status == 'failed' %>
                  <i class="bi bi-info-circle text-danger ms-1" 
                     data-bs-toggle="tooltip" 
                     title="<%= controller.last_sync_message %>"></i>
                <% end %>
              </td>
              <td>
                <% if controller.last_sync_at %>
                  <%= time_ago_in_words(controller.last_sync_at) %> ago
                <% else %>
                  <span class="text-muted">Never</span>
                <% end %>
              </td>
              <td>
                <% if controller.enabled? %>
                  <span class="badge text-bg-success">Enabled</span>
                <% else %>
                  <span class="badge text-bg-secondary">Disabled</span>
                <% end %>
              </td>
              <td class="text-end">
                <div class="btn-group btn-group-sm">
                  <%= link_to "Edit", edit_access_controller_path(controller), class: "btn btn-outline-secondary" %>
                  <%= button_to controller.enabled? ? "Disable" : "Enable",
                      toggle_access_controller_path(controller),
                      method: :post,
                      class: "btn btn-outline-#{controller.enabled? ? 'warning' : 'success'}" %>
                  <%= button_to "Delete", access_controller_path(controller),
                      method: :delete,
                      class: "btn btn-outline-danger",
                      data: { turbo_confirm: "Are you sure you want to delete '#{controller.name}'?" } %>
                </div>
                <% actions = Array(controller.access_controller_type&.actions).map(&:to_s).reject(&:blank?).uniq.sort %>
                <% if actions.any? %>
                  <div class="mt-2 d-flex flex-wrap gap-1 justify-content-end">
                    <% actions.each do |action| %>
                      <% tooltip = controller.last_command == action ? controller.last_command_output : nil %>
                      <%= button_to action,
                          run_verb_access_controller_path(controller, action_name: action),
                          method: :post,
                          class: "btn btn-outline-info btn-sm",
                          data: tooltip.present? ? { bs_toggle: "tooltip", bs_title: tooltip, turbo: false } : { turbo: false },
                          disabled: !controller.enabled? %>
                    <% end %>
                  </div>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
<% else %>
  <div class="card shadow-sm border-0">
    <div class="card-body text-center py-5">
      <i class="bi bi-router display-4 text-muted mb-3 d-block"></i>
      <p class="text-muted mb-3">No access controllers configured yet.</p>
      <%= link_to "Add Your First Access Controller", new_access_controller_path, class: "btn btn-primary" %>
    </div>
  </div>
<% end %>

<script>
  // Initialize Bootstrap tooltips
  document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function(tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
  });
</script>
