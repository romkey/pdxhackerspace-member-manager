<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h3 mb-1">Access Controllers</h1>
    <p class="text-muted mb-0">Manage access control devices for RFID key synchronization.</p>
  </div>
  <div class="d-flex gap-2">
    <%= link_to "New Access Controller", new_access_controller_path, class: "btn btn-primary" %>
    <%= button_to "Sync All", sync_all_access_controllers_path, method: :post, class: "btn btn-outline-primary", data: { turbo: false } %>
    <%= link_to "Back to Settings", settings_path, class: "btn btn-secondary" %>
  </div>
</div>

<div data-controller="access-controller-live" data-access-controller-live-url-value="<%= recent_logs_access_controllers_path %>" data-access-controller-live-interval-value="3000">

<% if @access_controllers.any? %>
  <div class="card shadow-sm border-0">
    <div class="table-responsive">
      <table class="table mb-0 align-middle">
        <thead class="bg-body-tertiary">
          <tr>
            <th scope="col">Name</th>
            <th scope="col">Hostname</th>
            <th scope="col">Type</th>
            <th scope="col">Sync</th>
            <th scope="col">Ping</th>
            <th scope="col">Enabled</th>
            <th scope="col" class="text-end"></th>
          </tr>
        </thead>
        <tbody>
          <% @access_controllers.each do |controller| %>
            <tr class="<%= 'text-body-secondary opacity-75' unless controller.enabled? %>">
              <td class="border-0 pb-0">
                <strong><%= controller.name %></strong>
                <% if controller.description.present? %>
                  <br><span class="text-muted small"><%= truncate(controller.description, length: 60) %></span>
                <% end %>
              </td>
              <td class="border-0 pb-0"><code><%= controller.hostname %></code></td>
              <td class="border-0 pb-0">
                <% if controller.access_controller_type %>
                  <span class="badge text-bg-info"><%= controller.access_controller_type.name %></span>
                <% else %>
                  <span class="text-muted">—</span>
                <% end %>
              </td>
              <td class="border-0 pb-0">
                <span class="badge text-bg-<%= controller.status_badge_class %>">
                  <%= controller.status_label %>
                </span>
                <% if controller.last_sync_at %>
                  <br><small class="text-muted"><%= time_ago_in_words(controller.last_sync_at) %> ago</small>
                <% end %>
              </td>
              <td class="border-0 pb-0">
                <% if controller.supports_ping? %>
                  <span class="badge text-bg-<%= controller.ping_status_badge_class %>">
                    <%= controller.ping_status_label %>
                  </span>
                  <% if controller.last_ping_at %>
                    <br><small class="text-muted"><%= time_ago_in_words(controller.last_ping_at) %> ago</small>
                  <% end %>
                <% else %>
                  <span class="text-muted">—</span>
                <% end %>
              </td>
              <td class="border-0 pb-0">
                <% if controller.enabled? %>
                  <span class="badge text-bg-success">Enabled</span>
                <% else %>
                  <span class="badge text-bg-secondary">Disabled</span>
                <% end %>
              </td>
              <td class="border-0 pb-0 text-end">
                <div class="btn-group btn-group-sm">
                  <%= link_to "Edit", edit_access_controller_path(controller), class: "btn btn-outline-secondary" %>
                  <%= button_to controller.enabled? ? "Disable" : "Enable",
                      toggle_access_controller_path(controller),
                      method: :post,
                      class: "btn btn-outline-#{controller.enabled? ? 'warning' : 'success'}" %>
                  <%= button_to "Delete", access_controller_path(controller),
                      method: :delete,
                      class: "btn btn-outline-danger",
                      data: { turbo_confirm: "Are you sure you want to delete '#{controller.name}'?" } %>
                </div>
              </td>
            </tr>
            <% actions = Array(controller.access_controller_type&.actions).map(&:to_s).reject(&:blank?).uniq.sort %>
            <% if actions.any? %>
              <tr class="<%= 'text-body-secondary opacity-75' unless controller.enabled? %>">
                <td colspan="7" class="pt-0 pb-2">
                  <div class="d-flex flex-wrap gap-1 align-items-center">
                    <% actions.each do |action| %>
                      <%= button_to action,
                          run_verb_access_controller_path(controller, action_name: action),
                          method: :post,
                          class: "btn btn-outline-info btn-sm",
                          data: { turbo: false },
                          disabled: !controller.enabled? %>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
            <tr>
              <td colspan="7" class="p-0 border-0">
                <div data-access-controller-live-target="inlineResult" data-controller-id="<%= controller.id %>" style="display:none;" class="px-3 pb-2"></div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
<% else %>
  <div class="card shadow-sm border-0">
    <div class="card-body text-center py-5">
      <i class="bi bi-router display-4 text-muted mb-3 d-block"></i>
      <p class="text-muted mb-3">No access controllers configured yet.</p>
      <%= link_to "Add Your First Access Controller", new_access_controller_path, class: "btn btn-primary" %>
    </div>
  </div>
<% end %>

<%# Recent Logs Section %>
<div class="mt-5">
  <h2 class="h4 mb-3">Recent Logs</h2>
  <div class="card shadow-sm border-0">
    <div class="table-responsive">
      <table class="table mb-0 align-middle table-sm">
        <thead class="bg-body-tertiary">
          <tr>
            <th scope="col">Time</th>
            <th scope="col">Controller</th>
            <th scope="col">Action</th>
            <th scope="col">Status</th>
            <th scope="col">Exit Code</th>
            <th scope="col">Command</th>
            <th scope="col">Output</th>
          </tr>
        </thead>
        <tbody data-access-controller-live-target="logsBody">
          <% if @recent_logs.any? %>
            <% @recent_logs.each do |log| %>
              <tr class="<%= 'table-danger' if log.failed? %><%= 'table-warning' if log.running? %>">
                <td class="text-nowrap">
                  <small><%= log.created_at.strftime('%Y-%m-%d %H:%M:%S') %></small>
                  <% if log.duration %>
                    <br><small class="text-muted"><%= log.duration %>s</small>
                  <% end %>
                </td>
                <td>
                  <% if log.access_controller %>
                    <strong><%= log.access_controller.name %></strong>
                  <% else %>
                    <span class="text-muted">Deleted</span>
                  <% end %>
                </td>
                <td><code><%= log.action %></code></td>
                <td>
                  <span class="badge text-bg-<%= log.status_badge_class %>">
                    <%= log.status.titleize %>
                  </span>
                </td>
                <td>
                  <% if log.exit_code.present? %>
                    <code><%= log.exit_code %></code>
                  <% else %>
                    <span class="text-muted">—</span>
                  <% end %>
                </td>
                <td>
                  <% if log.command_line.present? %>
                    <code class="small" style="max-width: 300px; display: inline-block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                          data-bs-toggle="tooltip"
                          data-bs-title="<%= log.command_line %>">
                      <%= truncate(log.command_line, length: 50) %>
                    </code>
                  <% else %>
                    <span class="text-muted">—</span>
                  <% end %>
                </td>
                <td>
                  <% if log.output.blank? && log.success? %>
                    <i class="bi bi-check-circle-fill text-success"></i>
                  <% elsif log.running? %>
                    <span class="spinner-border spinner-border-sm text-warning"></span>
                  <% else %>
                    <button type="button" class="btn btn-sm btn-outline-secondary" 
                            data-bs-toggle="modal" 
                            data-bs-target="#logOutputModal<%= log.id %>">
                      View
                    </button>
                    <!-- Modal -->
                    <div class="modal fade" id="logOutputModal<%= log.id %>" tabindex="-1" aria-hidden="true">
                      <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title">
                              Log Output: <%= log.access_controller&.name %> - <%= log.action %>
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                          <div class="modal-body">
                            <p class="text-muted small mb-2">
                              <strong>Time:</strong> <%= log.created_at.strftime('%Y-%m-%d %H:%M:%S') %><br>
                              <strong>Command:</strong> <code><%= log.command_line %></code><br>
                              <strong>Exit Code:</strong> <%= log.exit_code || 'N/A' %>
                            </p>
                            <% if log.output.present? %>
                              <pre class="bg-dark text-light p-3 rounded" style="max-height: 400px; overflow: auto;"><%= log.output %></pre>
                            <% else %>
                              <p class="text-muted fst-italic">No output produced.</p>
                            <% end %>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                          </div>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </td>
              </tr>
            <% end %>
          <% else %>
            <tr><td colspan="7" class="text-center text-muted py-4">No logs recorded yet.</td></tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

</div><%# end of access-controller-live controller %>

<script>
  // Initialize Bootstrap tooltips
  document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function(tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
  });
</script>
