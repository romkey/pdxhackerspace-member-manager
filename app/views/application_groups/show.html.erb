<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h3 mb-1"><%= @application_group.name %></h1>
    <p class="text-muted mb-0">Application: <%= link_to @application.name, application_path(@application), class: "text-decoration-none" %></p>
  </div>
  <div class="d-flex gap-2">
    <%= button_to "Sync to Authentik", sync_to_authentik_application_application_group_path(@application, @application_group),
        method: :post,
        class: "btn btn-outline-primary",
        data: { turbo_confirm: "Sync this group to Authentik?" } %>
    <%= link_to "Edit", edit_application_application_group_path(@application, @application_group), class: "btn btn-outline-secondary" %>
    <%= button_to "Delete", application_application_group_path(@application, @application_group),
        method: :delete,
        class: "btn btn-outline-danger",
        data: { turbo_confirm: "Are you sure you want to delete this group? This will also remove it from Authentik." } %>
    <%= link_to "&larr; Back to application".html_safe, application_path(@application), class: "text-decoration-none ms-2" %>
  </div>
</div>

<div class="card shadow-sm border-0 mb-4">
  <div class="card-body">
    <dl class="row mb-0">
      <dt class="col-sm-3 text-secondary">Name</dt>
      <dd class="col-sm-9"><%= @application_group.name %></dd>

      <dt class="col-sm-3 text-secondary">Authentik Name</dt>
      <dd class="col-sm-9"><code><%= @application_group.authentik_name %></code></dd>

      <dt class="col-sm-3 text-secondary">Authentik Group ID</dt>
      <dd class="col-sm-9">
        <% if @application_group.authentik_group_id.present? %>
          <code><%= @application_group.authentik_group_id %></code>
          <span class="badge text-bg-success ms-2">Webhook Sync Enabled</span>
        <% else %>
          <span class="text-muted fst-italic">Not configured</span>
        <% end %>
      </dd>

      <dt class="col-sm-3 text-secondary">Note</dt>
      <dd class="col-sm-9">
        <%= @application_group.note.presence || content_tag(:span, "No note", class: "text-muted fst-italic") %>
      </dd>

      <dt class="col-sm-3 text-secondary">Members</dt>
      <dd class="col-sm-9">
        <span class="badge text-bg-info"><%= @users.count %> members</span>
        <% syncable_count = @application_group.syncable_members.count %>
        <% if syncable_count < @users.count %>
          <span class="badge text-bg-warning ms-1"><%= syncable_count %> can sync</span>
        <% end %>
      </dd>
    </dl>
  </div>
</div>

<% if @unsyncable_members.any? %>
  <div class="alert alert-warning mb-4">
    <h6 class="alert-heading"><i class="bi bi-exclamation-triangle me-2"></i>Members Without Authentik IDs</h6>
    <p class="mb-2">
      The following <%= @unsyncable_members.count %> member(s) do not have Authentik IDs and cannot be synced to the Authentik group:
    </p>
    <ul class="mb-0">
      <% @unsyncable_members.limit(10).each do |user| %>
        <li><%= link_to user.display_name, user_path(user), class: "alert-link" %></li>
      <% end %>
      <% if @unsyncable_members.count > 10 %>
        <li class="text-muted">... and <%= @unsyncable_members.count - 10 %> more</li>
      <% end %>
    </ul>
  </div>
<% end %>

<% if @application_group.uses_default_group? %>
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
      <div class="alert alert-info mb-3">
        <% if @application_group.use_default_members_group? %>
          <strong>This group uses the default active members group.</strong> It automatically includes all active members and cannot have individual users added or removed.
        <% elsif @application_group.use_default_admins_group? %>
          <strong>This group uses the default admin members group.</strong> It automatically includes all admin members and cannot have individual users added or removed.
        <% elsif @application_group.use_can_train? && @application_group.training_topic %>
          <strong>This group uses members who can train in <%= @application_group.training_topic.name %>.</strong> It automatically includes all members who can train others in this topic and cannot have individual users added or removed.
        <% elsif @application_group.use_trained_in? && @application_group.training_topic %>
          <strong>This group uses members who are trained in <%= @application_group.training_topic.name %>.</strong> It automatically includes all members who have been trained in this topic and cannot have individual users added or removed.
        <% end %>
      </div>

      <h6 class="text-muted mb-3">Current Members (<%= @users.count %>)</h6>
    </div>
    <div class="table-responsive">
      <table class="table mb-0 align-middle">
        <thead class="bg-body-tertiary">
          <tr>
            <th scope="col">Name</th>
            <th scope="col">Email</th>
            <th scope="col">Status</th>
            <th scope="col">Authentik</th>
          </tr>
        </thead>
        <tbody>
          <% if @users.any? %>
            <% @users.each do |user| %>
              <tr>
                <td class="fw-semibold">
                  <%= link_to user.display_name, user_path(user), class: "text-decoration-none" %>
                </td>
                <td>
                  <% if user.email.present? %>
                    <%= mail_to user.email %>
                  <% else %>
                    <span class="text-muted fst-italic">Not provided</span>
                  <% end %>
                </td>
                <td>
                  <% badge_class = case user.membership_status
                     when "paying" then "success"
                     when "guest" then "warning"
                     when "banned" then "danger"
                     when "deceased" then "dark"
                     when "sponsored" then "primary"
                     when "applicant" then "light text-dark"
                     when "unknown" then "secondary"
                     else "secondary"
                     end %>
                  <span class="badge text-bg-<%= badge_class %>">
                    <%= user.membership_status.humanize %>
                  </span>
                  <% if user.active? %>
                    <span class="badge text-bg-success ms-1">Active</span>
                  <% end %>
                </td>
                <td>
                  <% if user.authentik_id.present? %>
                    <span class="badge text-bg-success" title="<%= user.authentik_id %>">
                      <i class="bi bi-check-lg"></i> Linked
                    </span>
                  <% else %>
                    <span class="badge text-bg-warning" title="Cannot sync to Authentik">
                      <i class="bi bi-x-lg"></i> No ID
                    </span>
                  <% end %>
                </td>
              </tr>
            <% end %>
          <% else %>
            <tr>
              <td colspan="4" class="text-center text-muted py-4">
                No members match the criteria for this group.
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
<% else %>
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="h5 mb-0">Users in Group</h2>
    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addUserModal">
      Add User
    </button>
  </div>

  <div class="card shadow-sm border-0 mb-4">
    <div class="table-responsive">
      <table class="table mb-0 align-middle">
        <thead class="bg-body-tertiary">
          <tr>
            <th scope="col">Name</th>
            <th scope="col">Email</th>
            <th scope="col">Status</th>
            <th scope="col">Authentik</th>
            <% unless @application_group.uses_default_group? %>
              <th scope="col">Actions</th>
            <% end %>
          </tr>
        </thead>
        <tbody>
          <% if @users.any? %>
            <% @users.each do |user| %>
              <tr>
                <td class="fw-semibold">
                  <%= link_to user.display_name, user_path(user), class: "text-decoration-none" %>
                </td>
                <td>
                  <% if user.email.present? %>
                    <%= mail_to user.email %>
                  <% else %>
                    <span class="text-muted fst-italic">Not provided</span>
                  <% end %>
                </td>
                <td>
                  <% badge_class = case user.membership_status
                     when "paying" then "success"
                     when "guest" then "warning"
                     when "banned" then "danger"
                     when "deceased" then "dark"
                     when "sponsored" then "primary"
                     when "applicant" then "light text-dark"
                     when "unknown" then "secondary"
                     else "secondary"
                     end %>
                  <span class="badge text-bg-<%= badge_class %>">
                    <%= user.membership_status.humanize %>
                  </span>
                  <% if user.active? %>
                    <span class="badge text-bg-success ms-1">Active</span>
                  <% end %>
                </td>
                <td>
                  <% if user.authentik_id.present? %>
                    <span class="badge text-bg-success" title="<%= user.authentik_id %>">
                      <i class="bi bi-check-lg"></i> Linked
                    </span>
                  <% else %>
                    <span class="badge text-bg-warning" title="Cannot sync to Authentik">
                      <i class="bi bi-x-lg"></i> No ID
                    </span>
                  <% end %>
                </td>
                <% unless @application_group.uses_default_group? %>
                  <td>
                    <%= button_to "Remove", remove_user_application_application_group_path(@application, @application_group, user_id: user.id), 
                        method: :delete, 
                        class: "btn btn-sm btn-outline-danger", 
                        data: { turbo: false, confirm: "Are you sure you want to remove #{user.display_name} from this group?" } %>
                  </td>
                <% end %>
              </tr>
            <% end %>
          <% else %>
            <tr>
              <td colspan="<%= @application_group.uses_default_group? ? 4 : 5 %>" class="text-center text-muted py-4">
                No users in this group yet.<%= ' Click "Add User" to add some.' unless @application_group.uses_default_group? %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Add User Modal -->
<% end %>
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addUserModalLabel">Add User to Group</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <input type="search" id="userSearchInput" class="form-control" placeholder="Search by name, email, or Authentik IDâ€¦" autocomplete="off">
        </div>
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
          <table class="table table-sm mb-0" id="usersTable">
            <thead class="bg-body-tertiary sticky-top">
              <tr>
                <th scope="col">Name</th>
                <th scope="col">Email</th>
                <th scope="col">Status</th>
                <th scope="col">Action</th>
              </tr>
            </thead>
            <tbody>
              <% @all_users.each do |user| %>
                <% next if @users.include?(user) %>
                <tr class="user-row" data-name="<%= user.display_name.downcase %>" data-email="<%= (user.email || '').downcase %>" data-authentik-id="<%= (user.authentik_id || '').downcase %>">
                  <td class="fw-semibold"><%= user.display_name %></td>
                  <td>
                    <% if user.email.present? %>
                      <%= mail_to user.email %>
                    <% else %>
                      <span class="text-muted fst-italic">Not provided</span>
                    <% end %>
                  </td>
                  <td>
                    <% badge_class = case user.membership_status
                       when "paying" then "success"
                       when "guest" then "warning"
                       when "banned" then "danger"
                       when "deceased" then "dark"
                       when "sponsored" then "primary"
                       when "applicant" then "light text-dark"
                       when "unknown" then "secondary"
                       else "secondary"
                       end %>
                    <span class="badge text-bg-<%= badge_class %>">
                      <%= user.membership_status.humanize %>
                    </span>
                    <% if user.active? %>
                      <span class="badge text-bg-success ms-1">Active</span>
                    <% end %>
                  </td>
                  <td>
                    <%= button_to "Add", add_user_application_application_group_path(@application, @application_group, user_id: user.id), 
                        method: :post, 
                        class: "btn btn-sm btn-primary", 
                        data: { turbo: false } %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const addUserModal = document.getElementById('addUserModal');
    const searchInput = document.getElementById('userSearchInput');
    
    if (addUserModal && searchInput) {
      let userRows = [];
      
      // Query rows when modal is shown
      addUserModal.addEventListener('shown.bs.modal', function() {
        userRows = Array.from(addUserModal.querySelectorAll('.user-row'));
      });
      
      // Add input listener once
      searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        
        // Re-query rows if not already cached (fallback)
        if (userRows.length === 0) {
          userRows = Array.from(addUserModal.querySelectorAll('.user-row'));
        }
        
        userRows.forEach(function(row) {
          const name = row.getAttribute('data-name') || '';
          const email = row.getAttribute('data-email') || '';
          const authentikId = row.getAttribute('data-authentik-id') || '';
          
          if (searchTerm === '' || 
              name.includes(searchTerm) || 
              email.includes(searchTerm) || 
              authentikId.includes(searchTerm)) {
            row.style.display = '';
          } else {
            row.style.display = 'none';
          }
        });
      });
      
      // Clear search when modal is hidden
      addUserModal.addEventListener('hidden.bs.modal', function() {
        searchInput.value = '';
        userRows.forEach(function(row) {
          row.style.display = '';
        });
        userRows = []; // Clear cache
      });
    }
  });
</script>
