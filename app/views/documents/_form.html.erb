<%= form_with model: document, class: "needs-validation" do |f| %>
  <% if document.errors.any? %>
    <div class="alert alert-danger">
      <h6 class="alert-heading">Please fix the following errors:</h6>
      <ul class="mb-0">
        <% document.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="mb-3">
    <%= f.label :title, class: "form-label" %>
    <%= f.text_field :title, class: "form-control", required: true %>
  </div>

  <div class="mb-3">
    <%= f.label :file, class: "form-label" %>
    <% if document.file.attached? %>
      <div class="mb-2">
        <span class="text-muted">Current file:</span>
        <%= link_to document.filename, download_document_path(document), class: "text-decoration-none" %>
        <span class="text-muted small">(<%= number_to_human_size(document.file.byte_size) %>)</span>
      </div>
    <% end %>
    <%= f.file_field :file, class: "form-control", required: !document.file.attached? %>
    <div class="form-text">Upload a new file to replace the existing one, or leave empty to keep the current file.</div>
  </div>

  <% if current_user_admin? %>
    <div class="mb-3">
      <div class="form-check">
        <%= f.check_box :show_on_all_profiles, class: "form-check-input" %>
        <%= f.label :show_on_all_profiles, "Show on all member profiles", class: "form-check-label" %>
      </div>
      <div class="form-text">When checked, this document will appear on every member's profile regardless of training.</div>
    </div>
  <% end %>

  <div class="mb-3">
    <%= f.label :training_topic_ids, "Training Topics", class: "form-label" %>
    <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
      <% @training_topics.each do |topic| %>
        <div class="form-check">
          <%= check_box_tag "document[training_topic_ids][]", topic.id, 
              document.training_topics.include?(topic), 
              class: "form-check-input", id: "topic_#{topic.id}" %>
          <%= label_tag "topic_#{topic.id}", topic.name, class: "form-check-label" %>
        </div>
      <% end %>
    </div>
    <div class="form-text">Select which training topics this document should be associated with (only applies when "Show on all profiles" is unchecked).</div>
    <%# Hidden field to allow clearing all selections %>
    <%= hidden_field_tag "document[training_topic_ids][]", "" %>
  </div>

  <% if params[:return_to_topic].present? %>
    <%= hidden_field_tag :return_to_topic, params[:return_to_topic] %>
  <% end %>

  <div class="d-flex gap-2">
    <%= f.submit document.persisted? ? "Update Document" : "Create Document", class: "btn btn-primary" %>
    <% if params[:return_to_topic].present? %>
      <%= link_to "Cancel", edit_training_topic_path(params[:return_to_topic]), class: "btn btn-outline-secondary" %>
    <% else %>
      <%= link_to "Cancel", documents_path, class: "btn btn-outline-secondary" %>
    <% end %>
  </div>
<% end %>
