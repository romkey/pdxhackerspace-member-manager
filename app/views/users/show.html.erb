<%# View Preview Selector - for admins and profile owners %>
<% if @can_preview_views %>
  <div class="card border-info mb-4">
    <div class="card-body py-2">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <div class="d-flex align-items-center gap-2">
          <i class="bi bi-eye text-info"></i>
          <span class="text-muted small">Preview profile as:</span>
          <%= form_with url: user_path(@user), method: :get, local: true, class: "d-inline-flex align-items-center gap-2" do %>
            <%= select_tag :view_as, 
                options_for_select(@available_views, @view_level), 
                class: "form-select form-select-sm", 
                style: "width: auto;",
                onchange: "this.form.submit();" %>
          <% end %>
        </div>
        <% if @view_level != @natural_view_level %>
          <div class="d-flex align-items-center gap-2">
            <span class="badge bg-info">Previewing</span>
            <%= link_to "Exit Preview", user_path(@user), class: "btn btn-outline-info btn-sm" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

<%# Admin Toolbar - shown to admins but NOT when impersonating (to see exact user view) %>
<% if true_user_admin? && !impersonating? %>
  <% if @nav_params.present? %>
    <div class="alert alert-info py-2 mb-3 d-flex justify-content-between align-items-center">
      <small>
        <i class="bi bi-funnel me-1"></i> Browsing filtered list
        <% if @nav_params[:membership_status].present? %>
          — Membership: <strong><%= @nav_params[:membership_status].humanize %></strong>
        <% end %>
        <% if @nav_params[:payment_type].present? %>
          — Payment: <strong><%= @nav_params[:payment_type].humanize %></strong>
        <% end %>
        <% if @nav_params[:dues_status].present? %>
          — Dues: <strong><%= @nav_params[:dues_status].humanize %></strong>
        <% end %>
        <% if @nav_params[:active].present? %>
          — <%= @nav_params[:active] == 'true' ? 'Active only' : 'Inactive only' %>
        <% end %>
      </small>
      <%= link_to "Clear filter", user_path(@user), class: "btn btn-outline-secondary btn-sm" %>
    </div>
  <% end %>
  <div class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="d-flex gap-2 align-items-center">
        <% if @previous_user %>
          <%= link_to user_path(@previous_user, @nav_params), class: "btn btn-outline-secondary", title: "Previous: #{@previous_user.display_name}" do %>
            <i class="bi bi-chevron-left"></i> Previous
          <% end %>
        <% else %>
          <span class="btn btn-outline-secondary disabled" title="First user">
            <i class="bi bi-chevron-left"></i> Previous
          </span>
        <% end %>
        
        <% if @next_user %>
          <%= link_to user_path(@next_user, @nav_params), class: "btn btn-outline-secondary", title: "Next: #{@next_user.display_name}" do %>
            Next <i class="bi bi-chevron-right"></i>
          <% end %>
        <% else %>
          <span class="btn btn-outline-secondary disabled" title="Last user">
            Next <i class="bi bi-chevron-right"></i>
          </span>
        <% end %>
        
        <%= link_to "Edit user", edit_user_path(@user), class: "btn btn-outline-secondary" %>
        <% unless impersonating? || @user == true_user %>
          <%= button_to impersonate_user_path(@user), method: :post, class: "btn btn-outline-info", 
              data: { turbo: false, confirm_message: "View the site as #{@user.display_name}? You can stop impersonating at any time." },
              onclick: "return confirm(this.dataset.confirmMessage);" do %>
            <i class="bi bi-person-badge me-1"></i> Impersonate
          <% end %>
        <% end %>
      </div>
      
      <div>
        <%= link_to "&larr; Back to users".html_safe, users_path(@nav_params), class: "text-decoration-none" %>
      </div>
    </div>
    
    <div class="d-flex gap-2 justify-content-center">
      <% if @user.active? %>
        <%= button_to "Deactivate", deactivate_user_path(@user), method: :post, class: "btn btn-outline-warning", 
            data: { turbo: false, confirm_message: "Are you sure you want to deactivate #{@user.display_name}?" },
            onclick: "return confirm(this.dataset.confirmMessage);" %>
      <% else %>
        <%= button_to "Activate", activate_user_path(@user), method: :post, class: "btn btn-outline-success", 
            data: { turbo: false, confirm_message: "Are you sure you want to activate #{@user.display_name}?" },
            onclick: "return confirm(this.dataset.confirmMessage);" %>
      <% end %>
      
      <%= button_to "Ban", ban_user_path(@user), method: :post, class: "btn btn-outline-danger", 
          data: { turbo: false, confirm_message: "Are you sure you want to ban #{@user.display_name}?" },
          onclick: "return confirm(this.dataset.confirmMessage);" %>
      
      <%= button_to "Deceased", mark_deceased_user_path(@user), method: :post, class: "btn btn-outline-secondary", 
          data: { turbo: false, confirm_message: "Are you sure you want to mark #{@user.display_name} as deceased?" },
          onclick: "return confirm(this.dataset.confirmMessage);" %>
      
      <span class="ms-4"></span>
      
      <%= button_to "Delete", user_path(@user), method: :delete, class: "btn btn-outline-danger", 
          data: { turbo: false, confirm_message: "WARNING: This will permanently delete #{@user.display_name}. Are you sure?" },
          onclick: "return confirm(this.dataset.confirmMessage);" %>

      <% if @user.authentik_id.present? %>
        <span class="ms-4"></span>
        <%= button_to sync_to_authentik_user_path(@user), method: :post, class: "btn btn-outline-primary",
            title: "Push local changes to Authentik", data: { turbo: false } do %>
          <i class="bi bi-cloud-upload"></i> Push to Authentik
        <% end %>
        <%= button_to sync_from_authentik_user_path(@user), method: :post, class: "btn btn-outline-primary",
            title: "Pull changes from Authentik", data: { turbo: false } do %>
          <i class="bi bi-cloud-download"></i> Pull from Authentik
        <% end %>
      <% end %>
    </div>
  </div>
<% end %>

<%# Profile content based on view level %>
<% if @view_level == :admin %>
<% elsif @view_level == :self %>
  <div class="mb-4">
    <div class="d-flex justify-content-between align-items-center">
      <h1 class="h5 mb-0">Your Profile</h1>
      <%= link_to "Edit Profile", edit_user_path(@user), class: "btn btn-outline-secondary btn-sm" %>
    </div>
  </div>
<% elsif @view_level == :members %>
  <div class="mb-4">
    <h1 class="h5 mb-0">Member Profile</h1>
  </div>
<% end %>

<%# Profile photo URL %>
<%
  image_url = if @user.avatar.present?
    @user.avatar
  elsif @user.email.present?
    gravatar_url(@user.email, size: 192)
  elsif @user.slack_user&.raw_attributes&.dig("profile", "image_192").present?
    @user.slack_user.raw_attributes.dig("profile", "image_192")
  end
%>

<%# Name and Photo Header - shown to all, outside tabs %>
<div class="card shadow-sm border-0 mb-4">
  <div class="card-body">
    <div class="d-flex align-items-center gap-4">
      <% if image_url.present? %>
        <img src="<%= image_url %>" alt="<%= @user.display_name %>" class="rounded-circle" style="width: 96px; height: 96px; object-fit: cover;">
      <% else %>
        <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center" style="width: 96px; height: 96px;">
          <i class="bi bi-person-fill text-white" style="font-size: 48px;"></i>
        </div>
      <% end %>
      <div>
        <h1 class="h3 mb-1"><%= @user.display_name %></h1>
        <% if @user.pronouns.present? %>
          <span class="text-muted"><%= @user.pronouns %></span>
        <% end %>
        <% if @user.membership_start_date.present? %>
          <div class="text-muted small mt-1">
            <i class="bi bi-calendar-check me-1"></i>Member since <%= @user.membership_start_date.strftime('%B %Y') %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<% if @view_level == :admin %>
  <%# ===== ADMIN VIEW WITH TABS ===== %>
  <ul class="nav nav-tabs mb-4" role="tablist">
    <li class="nav-item" role="presentation">
      <%= link_to user_path(@user, tab: :profile, view_as: params[:view_as]), 
          class: "nav-link #{'active' if @active_tab == :profile}", 
          role: "tab" do %>
        <i class="bi bi-person me-1"></i> Profile
      <% end %>
    </li>
    <li class="nav-item" role="presentation">
      <%= link_to user_path(@user, tab: :payments, view_as: params[:view_as]), 
          class: "nav-link #{'active' if @active_tab == :payments}", 
          role: "tab" do %>
        <i class="bi bi-credit-card me-1"></i> Payments
        <% if @payments_count.to_i > 0 %>
          <span class="badge bg-secondary ms-1"><%= @payments_count %></span>
        <% end %>
      <% end %>
    </li>
    <li class="nav-item" role="presentation">
      <%= link_to user_path(@user, tab: :access, view_as: params[:view_as]), 
          class: "nav-link #{'active' if @active_tab == :access}", 
          role: "tab" do %>
        <i class="bi bi-door-open me-1"></i> Access
        <% if @access_count.to_i > 0 %>
          <span class="badge bg-secondary ms-1"><%= @access_count %></span>
        <% end %>
      <% end %>
    </li>
    <% if @incidents_count.to_i > 0 %>
      <li class="nav-item" role="presentation">
        <%= link_to user_path(@user, tab: :incidents, view_as: params[:view_as]), 
            class: "nav-link #{'active' if @active_tab == :incidents}", 
            role: "tab" do %>
          <i class="bi bi-exclamation-triangle me-1"></i> Incidents
          <span class="badge bg-warning text-dark ms-1"><%= @incidents_count %></span>
        <% end %>
      </li>
    <% end %>
    <li class="nav-item" role="presentation">
      <%= link_to user_path(@user, tab: :journal, view_as: params[:view_as]), 
          class: "nav-link #{'active' if @active_tab == :journal}", 
          role: "tab" do %>
        <i class="bi bi-journal-text me-1"></i> Journal
        <% if @journals_count.to_i > 0 %>
          <span class="badge bg-secondary ms-1"><%= @journals_count %></span>
        <% end %>
      <% end %>
    </li>
  </ul>

  <div class="tab-content">
    <% if @active_tab == :profile %>
      <%= render 'users/tab_profile_admin', user: @user, most_recent_access: @most_recent_access %>
    <% elsif @active_tab == :payments %>
      <%= render 'users/tab_payments', payments: @payments, pagy: @pagy_payments, user: @user, show_payment_links: true %>
    <% elsif @active_tab == :access %>
      <%= render 'users/tab_access', recent_accesses: @recent_accesses, pagy: @pagy_accesses, user: @user %>
    <% elsif @active_tab == :incidents %>
      <%= render 'users/tab_incidents', user_incidents: @user_incidents, pagy: @pagy_incidents, user: @user %>
    <% elsif @active_tab == :journal %>
      <%= render 'users/tab_journal', journals: @journals, pagy: @pagy_journals, user: @user %>
    <% end %>
  </div>

<% elsif @view_level == :self %>
  <%# ===== SELF VIEW WITH TABS ===== %>
  <ul class="nav nav-tabs mb-4" role="tablist">
    <li class="nav-item" role="presentation">
      <%= link_to user_path(@user, tab: :profile, view_as: params[:view_as]), 
          class: "nav-link #{'active' if @active_tab == :profile}", 
          role: "tab" do %>
        <i class="bi bi-person me-1"></i> Profile
      <% end %>
    </li>
    <li class="nav-item" role="presentation">
      <%= link_to user_path(@user, tab: :payments, view_as: params[:view_as]), 
          class: "nav-link #{'active' if @active_tab == :payments}", 
          role: "tab" do %>
        <i class="bi bi-credit-card me-1"></i> Payment History
        <% if @payments_count.to_i > 0 %>
          <span class="badge bg-secondary ms-1"><%= @payments_count %></span>
        <% end %>
      <% end %>
    </li>
  </ul>

  <div class="tab-content">
    <% if @active_tab == :profile %>
      <%= render 'users/tab_profile_self', user: @user %>
    <% elsif @active_tab == :payments %>
      <%= render 'users/tab_payments', payments: @payments, pagy: @pagy_payments, user: @user, show_payment_links: false %>
    <% end %>
  </div>

<% elsif @view_level == :members %>
  <%# ===== MEMBERS VIEW - NO TABS ===== %>
  <%= render 'users/tab_profile_members', user: @user %>

<% else %>
  <%# ===== PUBLIC VIEW - NO TABS ===== %>
  <%= render 'users/tab_profile_public', user: @user %>
<% end %>
