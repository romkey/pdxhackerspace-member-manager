<% if current_user_admin? %>
  <div class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="d-flex gap-2 align-items-center">
        <% if @previous_user %>
          <%= link_to user_path(@previous_user), class: "btn btn-outline-secondary", title: "Previous: #{@previous_user.display_name}" do %>
            <i class="bi bi-chevron-left"></i> Previous
          <% end %>
        <% else %>
          <span class="btn btn-outline-secondary disabled" title="First user">
            <i class="bi bi-chevron-left"></i> Previous
          </span>
        <% end %>
        
        <% if @next_user %>
          <%= link_to user_path(@next_user), class: "btn btn-outline-secondary", title: "Next: #{@next_user.display_name}" do %>
            Next <i class="bi bi-chevron-right"></i>
          <% end %>
        <% else %>
          <span class="btn btn-outline-secondary disabled" title="Last user">
            Next <i class="bi bi-chevron-right"></i>
          </span>
        <% end %>
        
        <%= link_to "Edit user", edit_user_path(@user), class: "btn btn-outline-secondary" %>
      </div>
      
      <div>
        <%= link_to "&larr; Back to users".html_safe, users_path, class: "text-decoration-none" %>
      </div>
    </div>
    
    <div class="d-flex gap-2 justify-content-center">
      <% if @user.active? %>
        <%= button_to "Deactivate", deactivate_user_path(@user), method: :post, class: "btn btn-outline-warning", 
            data: { 
              turbo: false,
              confirm_message: "Are you sure you want to deactivate #{@user.display_name}?"
            },
            onclick: "return confirm(this.dataset.confirmMessage);" %>
      <% else %>
        <%= button_to "Activate", activate_user_path(@user), method: :post, class: "btn btn-outline-success", 
            data: { 
              turbo: false,
              confirm_message: "Are you sure you want to activate #{@user.display_name}?"
            },
            onclick: "return confirm(this.dataset.confirmMessage);" %>
      <% end %>
      
      <%= button_to "Ban", ban_user_path(@user), method: :post, class: "btn btn-outline-danger", 
          data: { 
            turbo: false,
            confirm_message: "Are you sure you want to ban #{@user.display_name}? This will set their membership status to 'banned' and deactivate them."
          },
          onclick: "return confirm(this.dataset.confirmMessage);" %>
      
      <%= button_to "Deceased", mark_deceased_user_path(@user), method: :post, class: "btn btn-outline-secondary", 
          data: { 
            turbo: false,
            confirm_message: "Are you sure you want to mark #{@user.display_name} as deceased? This will set their membership status to 'deceased' and deactivate them."
          },
          onclick: "return confirm(this.dataset.confirmMessage);" %>
      
      <span class="ms-4"></span>
      
      <%= button_to "Delete", user_path(@user), method: :delete, class: "btn btn-outline-danger", 
          data: { 
            turbo: false,
            confirm_message: "WARNING: This will permanently delete #{@user.display_name} and all associated data. This action cannot be undone. Consider deactivating the user instead. Are you absolutely sure you want to delete this user?"
          },
          onclick: "return confirm(this.dataset.confirmMessage);" %>
    </div>
  </div>
<% else %>
  <div class="mb-4">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h1 class="h5 mb-0">Your profile</h1>
      </div>
      <div>
        <%= link_to "Edit profile", edit_user_path(@user), class: "btn btn-outline-secondary btn-sm" %>
      </div>
    </div>
  </div>
<% end %>

<%
  image_url = if @user.avatar.present?
    @user.avatar
  elsif @user.email.present?
    gravatar_url(@user.email, size: 192)
  elsif @user.slack_user&.raw_attributes&.dig("profile", "image_192").present?
    @user.slack_user.raw_attributes.dig("profile", "image_192")
  end
%>

<div class="card shadow-sm border-0">
  <div class="card-body">
    <h1 class="h4 mb-3"><%= @user.display_name %></h1>
    <% if current_user_admin? %>
      <div class="row">
      <div class="col-md-8">
        <dl class="row mb-0">
      <dt class="col-sm-3 text-secondary">Username</dt>
      <dd class="col-sm-9 text-monospace text-secondary"><%= @user.username.presence || content_tag(:span, "Not provided", class: "text-muted fst-italic") %></dd>

      <dt class="col-sm-3 text-secondary">Authentik ID</dt>
      <dd class="col-sm-9"><%= @user.authentik_id %></dd>

      <dt class="col-sm-3 text-secondary">Email</dt>
      <dd class="col-sm-9">
        <% if @user.email.present? %>
          <%= mail_to @user.email %>
        <% else %>
          <span class="text-muted fst-italic">Not provided</span>
        <% end %>
      </dd>

      <dt class="col-sm-3 text-secondary">Extra emails</dt>
      <dd class="col-sm-9">
        <% if @user.extra_emails.present? && @user.extra_emails.any? %>
          <% @user.extra_emails.each do |email| %>
            <%= mail_to email %><br>
          <% end %>
        <% else %>
          <span class="text-muted fst-italic">None</span>
        <% end %>
      </dd>

      <dt class="col-sm-3 text-secondary">Full name</dt>
      <dd class="col-sm-9"><%= @user.full_name.presence || content_tag(:span, "Not provided", class: "text-muted fst-italic") %></dd>

      <dt class="col-sm-3 text-secondary">Sheet Entry</dt>
      <dd class="col-sm-9">
        <% if @user.sheet_entry.present? %>
          <%= link_to @user.sheet_entry.name, sheet_entry_path(@user.sheet_entry), class: "text-decoration-none" %>
        <% else %>
          <span class="text-muted fst-italic">Not linked</span>
        <% end %>
      </dd>

      <dt class="col-sm-3 text-secondary">Slack</dt>
      <dd class="col-sm-9">
        <% if @user.slack_handle.present? %>
          <% if @user.slack_id.present? && @user.slack_user&.team_id.present? %>
            <% slack_url = "slack://user?team=#{@user.slack_user.team_id}&id=#{@user.slack_id}" %>
            <%= link_to "@#{@user.slack_handle}", slack_url, target: "_blank", rel: "noopener", class: "text-decoration-none" %>
            <span class="text-muted small ms-2">(ID: <%= @user.slack_id %>)</span>
          <% else %>
            <span>@<%= @user.slack_handle %></span>
            <% if @user.slack_id.present? %>
              <span class="text-muted small ms-2">(ID: <%= @user.slack_id %>)</span>
            <% end %>
          <% end %>
        <% else %>
          <span class="text-muted fst-italic">Not linked</span>
        <% end %>
      </dd>

      <dt class="col-sm-3 text-secondary">Membership Status</dt>
      <dd class="col-sm-9">
        <% badge_class = case @user.membership_status
           when "coworking" then "success"
           when "basic" then "info"
           when "guest" then "warning"
           when "banned" then "danger"
           when "deceased" then "dark"
           when "sponsored" then "primary"
           when "unknown" then "secondary"
           else "secondary"
           end %>
        <span class="badge text-bg-<%= badge_class %>">
          <%= @user.membership_status.humanize %>
        </span>
        <% if @user.active? %>
          <span class="badge text-bg-success ms-2">Active</span>
        <% end %>
        <% member_status = (@user.authentik_attributes || {})["memberStatus"] %>
        <% if member_status.present? %>
          <span class="badge text-bg-info ms-2"><%= member_status %></span>
        <% end %>
      </dd>

      <dt class="col-sm-3 text-secondary">Payment Type</dt>
      <dd class="col-sm-9">
        <span class="badge text-bg-info"><%= @user.payment_type.humanize %></span>
      </dd>

      <dt class="col-sm-3 text-secondary">Dues Status</dt>
      <dd class="col-sm-9">
        <% dues_badge_class = case @user.dues_status
           when "current" then "success"
           when "lapsed" then "warning"
           when "inactive" then "secondary"
           when "unknown" then "secondary"
           else "secondary"
           end %>
        <span class="badge text-bg-<%= dues_badge_class %>"><%= @user.dues_status.humanize %></span>
      </dd>

      <dt class="col-sm-3 text-secondary">Trained on</dt>
      <dd class="col-sm-9">
        <% trained_topics = @user.trainings_as_trainee.map(&:training_topic).uniq %>
        <% if trained_topics.any? %>
          <% trained_topics.each do |topic| %>
            <span class="badge text-bg-primary me-1 mb-1"><%= topic.name %></span>
          <% end %>
        <% else %>
          <span class="text-muted fst-italic">None recorded</span>
        <% end %>
      </dd>

      <dt class="col-sm-3 text-secondary">Can train</dt>
      <dd class="col-sm-9">
        <% if @user.training_topics.any? %>
          <% @user.training_topics.each do |topic| %>
            <span class="badge text-bg-success me-1 mb-1"><%= topic.name %></span>
          <% end %>
        <% else %>
          <span class="text-muted fst-italic">None</span>
        <% end %>
      </dd>

      <dt class="col-sm-3 text-secondary">Last synced</dt>
      <dd class="col-sm-9">
        <%= @user.last_synced_at ? l(@user.last_synced_at, format: :long) : content_tag(:span, "Never", class: "text-muted fst-italic") %>
      </dd>

      <dt class="col-sm-3 text-secondary">Last login</dt>
      <dd class="col-sm-9">
        <%= @user.last_login_at ? l(@user.last_login_at, format: :long) : content_tag(:span, "Never", class: "text-muted fst-italic") %>
      </dd>

      <dt class="col-sm-3 text-secondary">Last access</dt>
      <dd class="col-sm-9">
        <% if @most_recent_access&.logged_at.present? %>
          <%= l(@most_recent_access.logged_at, format: :long) %>
          <% if @most_recent_access.location.present? %>
            <span class="text-muted small ms-2">(<%= @most_recent_access.location %>)</span>
          <% end %>
        <% else %>
          <span class="text-muted fst-italic">Never</span>
        <% end %>
      </dd>

      <dt class="col-sm-3 text-secondary">Created</dt>
      <dd class="col-sm-9"><%= l(@user.created_at, format: :long) %></dd>

      <dt class="col-sm-3 text-secondary">Updated</dt>
      <dd class="col-sm-9"><%= l(@user.updated_at, format: :long) %></dd>

      <dt class="col-sm-3 text-secondary">Notes</dt>
      <dd class="col-sm-9">
        <% if @user.notes.present? %>
          <%= simple_format(@user.notes) %>
        <% else %>
          <span class="text-muted fst-italic">None</span>
        <% end %>
      </dd>

      <dt class="col-sm-3 text-secondary">RFID Keys</dt>
      <dd class="col-sm-9">
        <% if @user.rfids.any? %>
          <div class="d-flex flex-column gap-2">
            <% @user.rfids.each do |rfid_record| %>
              <div>
                <code class="bg-body-secondary px-2 py-1 rounded me-2"><%= rfid_record.rfid %></code>
                <% if rfid_record.notes.present? %>
                  <span class="text-muted small ms-2"><%= rfid_record.notes %></span>
                <% end %>
              </div>
            <% end %>
          </div>
        <% else %>
          <span class="text-muted fst-italic">None</span>
        <% end %>
      </dd>
        </dl>
      </div>
      <div class="col-md-4">
        <div class="text-center">
          <% if image_url.present? %>
            <img src="<%= image_url %>" alt="<%= @user.display_name %>" class="img-fluid rounded" style="max-width: 192px; max-height: 192px;">
          <% else %>
            <div style="width: 192px; height: 192px; border-radius: 8px; background-color: #dee2e6; display: inline-block;"></div>
          <% end %>
        </div>
      </div>
    </div>
  <% else %>
    <div class="row">
      <div class="col-md-8">
        <dl class="row mb-0">
          <dt class="col-sm-3 text-secondary">Username</dt>
          <dd class="col-sm-9 text-monospace text-secondary"><%= @user.username.presence || content_tag(:span, "Not provided", class: "text-muted fst-italic") %></dd>

          <dt class="col-sm-3 text-secondary">Email</dt>
          <dd class="col-sm-9">
            <% if @user.email.present? %>
              <%= mail_to @user.email %>
            <% else %>
              <span class="text-muted fst-italic">Not provided</span>
            <% end %>
          </dd>

          <dt class="col-sm-3 text-secondary">Full name</dt>
          <dd class="col-sm-9"><%= @user.full_name.presence || content_tag(:span, "Not provided", class: "text-muted fst-italic") %></dd>

          <dt class="col-sm-3 text-secondary">Greeting Name</dt>
          <dd class="col-sm-9">
            <% if @user.greeting_name.present? %>
              <%= @user.greeting_name %>
            <% else %>
              <span class="text-muted fst-italic">Not provided</span>
            <% end %>
          </dd>

          <dt class="col-sm-3 text-secondary">Membership Status</dt>
          <dd class="col-sm-9">
            <% badge_class = case @user.membership_status
               when "coworking" then "success"
               when "basic" then "info"
               when "guest" then "warning"
               when "banned" then "danger"
               when "deceased" then "dark"
               when "sponsored" then "primary"
               when "unknown" then "secondary"
               else "secondary"
               end %>
            <span class="badge text-bg-<%= badge_class %>">
              <%= @user.membership_status.humanize %>
            </span>
          </dd>

          <dt class="col-sm-3 text-secondary">Payment Type</dt>
          <dd class="col-sm-9">
            <span class="badge text-bg-info"><%= @user.payment_type.humanize %></span>
          </dd>
        </dl>
      </div>
      <div class="col-md-4">
        <div class="text-center">
          <% if image_url.present? %>
            <img src="<%= image_url %>" alt="<%= @user.display_name %>" class="img-fluid rounded" style="max-width: 192px; max-height: 192px;">
          <% else %>
            <div style="width: 192px; height: 192px; border-radius: 8px; background-color: #dee2e6; display: inline-block;"></div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
  </div>
</div>

<% if current_user_admin? %>
  <%= render "paypal_payments/payment_history", payments: @payments %>

  <div class="card shadow-sm border-0 mt-4">
    <div class="card-body">
      <h2 class="h6 mb-3">Access</h2>
      <% if @recent_accesses.any? %>
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="bg-body-tertiary">
              <tr>
                <th scope="col">When</th>
                <th scope="col">Location</th>
                <th scope="col">Action</th>
                <th scope="col">Name</th>
              </tr>
            </thead>
            <tbody>
              <% @recent_accesses.each do |access| %>
                <tr>
                  <td>
                    <% if access.logged_at.present? %>
                      <%= l(access.logged_at, format: :long) %>
                    <% else %>
                      <span class="text-muted fst-italic">Unknown</span>
                    <% end %>
                  </td>
                  <td><%= access.location.presence || content_tag(:span, "—", class: "text-muted") %></td>
                  <td>
                    <% if access.action.present? %>
                      <span class="badge text-bg-secondary"><%= access.action.humanize %></span>
                    <% else %>
                      <span class="text-muted">—</span>
                    <% end %>
                  </td>
                  <td><%= access.name.presence || content_tag(:span, "—", class: "text-muted") %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <p class="text-muted mb-0">No access logs recorded yet.</p>
      <% end %>
    </div>
  </div>

  <div class="card shadow-sm border-0 mt-4">
    <div class="card-body">
      <h2 class="h6 mb-3">Journal</h2>
      <% if @journals.any? %>
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="bg-body-tertiary">
              <tr>
                <th scope="col">When</th>
                <th scope="col">Action</th>
                <th scope="col">By</th>
                <th scope="col">Changes</th>
              </tr>
            </thead>
            <tbody>
              <% @journals.each do |j| %>
                <tr>
                  <td><%= l(j.changed_at, format: :long) %></td>
                  <td><span class="badge text-bg-secondary"><%= j.action %></span></td>
                  <td>
                    <% if j.actor_user.present? %>
                      <%= link_to j.actor_user.display_name, user_path(j.actor_user) %>
                    <% else %>
                      <span class="text-muted fst-italic">System</span>
                    <% end %>
                  </td>
                  <td><%= render_change_rows(j.changes_json) %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <p class="text-muted mb-0">No journal entries yet.</p>
      <% end %>
    </div>
  </div>
<% end %>

