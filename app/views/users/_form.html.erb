<%= form_with model: @user,
              local: true,
              class: "vstack gap-3",
              data: {
                user_authentik_id: @user.authentik_id,
                user_username: @user.username
              } do |f| %>
  <div>
    <%= f.label :username, class: "form-label" %>
    <%= f.text_field :username, class: "form-control" %>
    <div class="form-text">Will be synced back to Authentik in the future.</div>
  </div>

  <div>
    <%= f.label :full_name, class: "form-label" %>
    <%= f.text_field :full_name, class: "form-control" %>
  </div>

  <div>
    <%= f.label :email, class: "form-label" %>
    <%= f.email_field :email, class: "form-control" %>
  </div>

  <div>
    <%= f.label :pronouns, class: "form-label" %>
    <%= f.text_field :pronouns, class: "form-control", placeholder: "e.g., they/them, she/her, he/him" %>
  </div>

  <div>
    <%= f.label :profile_visibility, "Profile Visibility", class: "form-label" %>
    <%= f.select :profile_visibility,
        options_for_select([
          ["Public (visible to anyone)", "public"],
          ["Other Members (visible to logged-in members)", "members"],
          ["Private (only visible to admins)", "private"]
        ], @user.profile_visibility),
        {},
        { class: "form-select" } %>
    <div class="form-text">Controls who can see your profile information.</div>
  </div>

  <div data-controller="rich-editor" data-rich-editor-variables-value="[]">
    <%= f.label :bio, "About Me", class: "form-label" %>
    <div class="mb-2">
      <small class="text-muted">Tell others about yourself, your interests, and what you're working on.</small>
    </div>
    <%= f.text_area :bio, class: "form-control", rows: 5, data: { rich_editor_target: "editor" } %>
  </div>

  <div>
    <%= f.label :greeting_name, "Greeting Name", class: "form-label" %>
    <small class="text-muted d-block mb-2">Name used on signs on entry</small>
    <%= f.text_field :greeting_name, class: "form-control", id: "user_greeting_name" %>
    
    <div class="mt-2">
      <div class="form-check">
        <%= f.check_box :use_full_name_for_greeting, class: "form-check-input", id: "user_use_full_name_for_greeting" %>
        <%= f.label :use_full_name_for_greeting, "Use Full Name", class: "form-check-label" %>
      </div>
      <div class="form-check">
        <%= f.check_box :use_username_for_greeting, class: "form-check-input", id: "user_use_username_for_greeting" %>
        <%= f.label :use_username_for_greeting, "Use Username", class: "form-check-label" %>
      </div>
      <div class="form-check">
        <%= f.check_box :do_not_greet, class: "form-check-input", id: "user_do_not_greet" %>
        <%= f.label :do_not_greet, "Do not greet", class: "form-check-label" %>
      </div>
    </div>
  </div>

  <% if current_user_admin? %>
    <div>
      <%= f.label :membership_status, "Membership Status", class: "form-label" %>
      <%= f.select :membership_status, 
          options_for_select([
            ["Paying", "paying"],
            ["Guest", "guest"],
            ["Banned", "banned"],
            ["Deceased", "deceased"],
            ["Sponsored", "sponsored"],
            ["Applicant", "applicant"],
            ["Cancelled", "cancelled"],
            ["Unknown", "unknown"]
          ], @user.membership_status),
          {},
          { class: "form-select" } %>
    </div>

    <div class="form-check">
      <%= f.check_box :active, class: "form-check-input" %>
      <%= f.label :active, "Active member", class: "form-check-label" %>
    </div>

    <div>
      <%= f.label :payment_type, class: "form-label" %>
      <%= f.select :payment_type, 
          options_for_select([
            ["Unknown", "unknown"],
            ["Sponsored", "sponsored"],
            ["PayPal", "paypal"],
            ["Recharge", "recharge"],
            ["Ko-Fi", "kofi"],
            ["Cash", "cash"],
            ["Inactive", "inactive"]
          ], @user.payment_type),
          {},
          { class: "form-select" } %>
    </div>

    <div>
      <%= f.label :membership_plan_id, "Membership Plan", class: "form-label" %>
      <%= f.select :membership_plan_id,
          options_from_collection_for_select(MembershipPlan.ordered, :id, :display_name, @user.membership_plan_id),
          { prompt: "No plan" },
          { class: "form-select" } %>
      <div class="form-text">Optional: Assign a membership plan to this user.</div>
    </div>

    <div>
      <%= f.label :aliases, "Aliases (alternate names)", class: "form-label" %>
      <%= f.text_field :aliases_text, value: @user.aliases&.join(", "), class: "form-control",
          placeholder: "e.g., Bob Smith, Robert J. Smith" %>
      <div class="form-text">Comma-separated list of alternate names used for matching payments and syncs.</div>
    </div>

    <div>
      <%= f.label :notes, class: "form-label" %>
      <%= f.text_area :notes, class: "form-control", rows: 4 %>
    </div>

    <div class="form-check">
      <%= f.check_box :is_admin, class: "form-check-input", id: "user_is_admin" %>
      <%= f.label :is_admin, "Administrator", class: "form-check-label" %>
    </div>
  <% end %>

  <div class="d-flex gap-2">
    <%= f.submit "Save", class: "btn btn-primary" %>
    <%= link_to "Cancel", @user.persisted? ? user_path(@user) : users_path, class: "btn btn-outline-secondary" %>
  </div>
<% end %>

<% if @user.persisted? %>
  <div class="card shadow-sm border-0 mt-4" id="links">
    <div class="card-header bg-body-tertiary">
      <h5 class="card-title mb-0">Profile Links</h5>
    </div>
    <div class="card-body">
      <p class="text-muted small mb-3">Add links to your website, social media, GitHub, and other profiles.</p>

      <% if @user.user_links.any? %>
        <div class="list-group mb-4">
          <% @user.user_links.ordered.each do |link| %>
            <div class="list-group-item d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center gap-3">
                <i class="bi <%= link.icon_class %> fs-5"></i>
                <div>
                  <strong><%= link.title %></strong>
                  <br>
                  <a href="<%= link.url %>" target="_blank" rel="noopener" class="text-muted small text-decoration-none"><%= truncate(link.url, length: 50) %></a>
                </div>
              </div>
              <div class="d-flex gap-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#edit-link-<%= link.id %>">
                  Edit
                </button>
                <%= button_to user_user_link_path(@user, link), method: :delete, class: "btn btn-sm btn-outline-danger", data: { turbo_confirm: "Remove this link?" } do %>
                  <i class="bi bi-trash"></i>
                <% end %>
              </div>
            </div>
            <div class="collapse" id="edit-link-<%= link.id %>">
              <div class="card card-body border-0 bg-body-tertiary">
                <%= form_with model: link, url: user_user_link_path(@user, link), method: :patch, local: true, class: "row g-2" do |lf| %>
                  <div class="col-md-4">
                    <%= lf.text_field :title, class: "form-control form-control-sm", placeholder: "Title" %>
                  </div>
                  <div class="col-md-6">
                    <%= lf.url_field :url, class: "form-control form-control-sm", placeholder: "https://..." %>
                  </div>
                  <div class="col-md-2">
                    <%= lf.submit "Update", class: "btn btn-sm btn-primary w-100" %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>

      <h6 class="text-muted">Add New Link</h6>
      <%= form_with model: UserLink.new, url: user_user_links_path(@user), local: true, class: "row g-2" do |lf| %>
        <div class="col-md-4">
          <%= lf.text_field :title, class: "form-control", placeholder: "Title (e.g., GitHub, Website)" %>
        </div>
        <div class="col-md-6">
          <%= lf.url_field :url, class: "form-control", placeholder: "https://..." %>
        </div>
        <div class="col-md-2">
          <%= lf.submit "Add Link", class: "btn btn-primary w-100" %>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const useFullNameCheckbox = document.getElementById('user_use_full_name_for_greeting');
    const useUsernameCheckbox = document.getElementById('user_use_username_for_greeting');
    const doNotGreetCheckbox = document.getElementById('user_do_not_greet');
    const greetingNameField = document.getElementById('user_greeting_name');
    const fullNameField = document.getElementById('user_full_name');
    const usernameField = document.getElementById('user_username');
    const form = document.querySelector('form[data-user-authentik-id]');

    function getUsername() {
      if (usernameField && usernameField.value) {
        return usernameField.value;
      }
      return form ? form.dataset.userUsername || '' : '';
    }

    let suppressGreetingInputHandler = false;

    function setGreetingValue(value) {
      if (!greetingNameField) return;
      suppressGreetingInputHandler = true;
      greetingNameField.value = value;
      suppressGreetingInputHandler = false;
    }

    function updateGreetingFromFullName() {
      setGreetingValue(fullNameField?.value || '');
    }

    function updateGreetingFromUsername() {
      setGreetingValue(getUsername());
    }

    function clearGreeting() {
      setGreetingValue('');
    }

    function enforceMutualExclusivity(selectedCheckbox) {
      const checkboxes = [useFullNameCheckbox, useUsernameCheckbox, doNotGreetCheckbox];
      checkboxes.forEach((checkbox) => {
        if (!checkbox || checkbox === selectedCheckbox) return;
        checkbox.checked = false;
      });
    }

    function handleSelection(selectedCheckbox) {
      if (!selectedCheckbox) return;
      if (!selectedCheckbox.checked) return;

      enforceMutualExclusivity(selectedCheckbox);

      if (selectedCheckbox === useFullNameCheckbox) {
        updateGreetingFromFullName();
      } else if (selectedCheckbox === useUsernameCheckbox) {
        updateGreetingFromUsername();
      } else if (selectedCheckbox === doNotGreetCheckbox) {
        clearGreeting();
      }
    }

    if (useFullNameCheckbox) {
      useFullNameCheckbox.addEventListener('change', function() {
        handleSelection(useFullNameCheckbox);
      });
    }

    if (useUsernameCheckbox) {
      useUsernameCheckbox.addEventListener('change', function() {
        handleSelection(useUsernameCheckbox);
      });
    }

    if (doNotGreetCheckbox) {
      doNotGreetCheckbox.addEventListener('change', function() {
        handleSelection(doNotGreetCheckbox);
      });
    }

    if (fullNameField) {
      fullNameField.addEventListener('input', function() {
        if (useFullNameCheckbox && useFullNameCheckbox.checked) {
          updateGreetingFromFullName();
        }
      });
    }

    if (usernameField) {
      usernameField.addEventListener('input', function() {
        if (useUsernameCheckbox && useUsernameCheckbox.checked) {
          updateGreetingFromUsername();
        }
      });
    }

    if (greetingNameField) {
      greetingNameField.addEventListener('input', function() {
        if (suppressGreetingInputHandler) {
          return;
        }

        if (greetingNameField.value.trim().length > 0) {
          [useFullNameCheckbox, useUsernameCheckbox, doNotGreetCheckbox].forEach((checkbox) => {
            if (checkbox) {
              checkbox.checked = false;
            }
          });
        }
      });
    }

    // Initialize the greeting name field based on current selection.
    if (useFullNameCheckbox && useFullNameCheckbox.checked) {
      updateGreetingFromFullName();
    } else if (useUsernameCheckbox && useUsernameCheckbox.checked) {
      updateGreetingFromUsername();
    } else if (doNotGreetCheckbox && doNotGreetCheckbox.checked) {
      clearGreeting();
    }
  });
</script>


