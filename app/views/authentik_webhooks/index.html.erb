<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="h3 mb-0">Authentik Webhooks</h1>
  <%= link_to "&larr; Back to Settings".html_safe, settings_path, class: "text-decoration-none" %>
</div>

<div class="row">
  <div class="col-lg-8">
    <div class="card shadow-sm border-0 mb-4">
      <div class="card-header bg-body-tertiary">
        <h5 class="mb-0">Webhook Configuration Status</h5>
      </div>
      <div class="card-body">
        <% if @status[:error] %>
          <div class="alert alert-danger mb-4">
            <i class="bi bi-exclamation-circle me-2"></i>
            <strong>Unable to check webhook status:</strong> <%= @status[:error] %>
          </div>
        <% elsif @status[:configured] %>
          <div class="alert alert-success mb-4">
            <i class="bi bi-check-circle me-2"></i>
            <strong>Webhooks are configured</strong>
          </div>

          <dl class="row mb-0">
            <dt class="col-sm-4">Transport</dt>
            <dd class="col-sm-8">
              <code><%= @status[:transport][:name] %></code>
              <span class="text-muted small ms-2">(<%= @status[:transport][:id] %>)</span>
            </dd>

            <dt class="col-sm-4">Webhook URL</dt>
            <dd class="col-sm-8">
              <code class="text-break"><%= @status[:transport][:webhook_url]&.gsub(/secret=[^&]+/, 'secret=***') %></code>
            </dd>

            <% if @status[:user_policy] %>
              <dt class="col-sm-4">User Policy</dt>
              <dd class="col-sm-8">
                <code><%= @status[:user_policy][:name] %></code>
              </dd>
            <% end %>

            <% if @status[:group_policy] %>
              <dt class="col-sm-4">Group Policy</dt>
              <dd class="col-sm-8">
                <code><%= @status[:group_policy][:name] %></code>
              </dd>
            <% end %>

            <dt class="col-sm-4">Notification Rule</dt>
            <dd class="col-sm-8">
              <code><%= @status[:rule][:name] %></code>
            </dd>
          </dl>

          <hr class="my-4">

          <div class="d-flex gap-2">
            <%= button_to "Reconfigure Webhooks", setup_authentik_webhooks_path, 
                method: :post, 
                class: "btn btn-outline-primary",
                data: { turbo_confirm: "This will update the webhook configuration. Continue?" } %>
            <%= button_to "Remove Configuration", teardown_authentik_webhooks_path, 
                method: :delete, 
                class: "btn btn-outline-danger",
                data: { turbo_confirm: "This will remove all webhook configuration from Authentik. Continue?" } %>
          </div>
        <% else %>
          <div class="alert alert-warning mb-4">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Webhooks are not configured</strong>
          </div>

          <p class="text-muted">
            Configure Authentik to send webhook notifications when users or groups change.
            This enables real-time synchronization of member data.
          </p>

          <% if @member_manager_base_url.blank? %>
            <div class="alert alert-danger">
              <i class="bi bi-x-circle me-2"></i>
              <strong>Missing configuration:</strong> Set the <code>MEMBER_MANAGER_BASE_URL</code> environment variable
              to your MemberManager public URL (e.g., <code>https://members.example.org</code>).
            </div>
          <% else %>
            <%= button_to "Set Up Webhooks", setup_authentik_webhooks_path, 
                method: :post, 
                class: "btn btn-primary",
                data: { turbo_confirm: "This will create webhook configuration in Authentik. Continue?" } %>
          <% end %>
        <% end %>
      </div>
    </div>

    <div class="card shadow-sm border-0">
      <div class="card-header bg-body-tertiary">
        <h5 class="mb-0">Synced Groups</h5>
      </div>
      <div class="card-body">
        <p class="text-muted">
          Events are filtered to only process changes for Application Groups that have an Authentik Group ID configured.
          Set the Authentik Group ID on each Application Group you want to sync.
        </p>

        <% if @synced_groups.any? %>
          <div class="alert alert-info mb-3">
            <strong>Filtering active:</strong> Processing events for <%= @synced_groups.count %> group(s).
          </div>
          <div class="table-responsive">
            <table class="table table-sm mb-0">
              <thead class="bg-body-tertiary">
                <tr>
                  <th>Application</th>
                  <th>Group Name</th>
                  <th>Authentik Group ID</th>
                </tr>
              </thead>
              <tbody>
                <% @synced_groups.each do |group| %>
                  <tr>
                    <td><%= link_to group.application.name, application_path(group.application) %></td>
                    <td><%= link_to group.name, application_application_group_path(group.application, group) %></td>
                    <td><code><%= group.authentik_group_id %></code></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="alert alert-warning mb-0">
            <strong>No groups configured:</strong> All events will be processed.
            <br><small>Add Authentik Group IDs to your Application Groups to filter events.</small>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card shadow-sm border-0">
      <div class="card-header bg-body-tertiary">
        <h5 class="mb-0">Configuration</h5>
      </div>
      <div class="card-body">
        <h6>API Token</h6>
        <% if Authentik::TokenManager.oauth_configured? %>
          <div class="alert alert-success py-2 small mb-3">
            <strong>Auto-refresh enabled</strong> &mdash; using OAuth2 client credentials to obtain API tokens automatically.
          </div>
        <% elsif AuthentikConfig.settings.api_token.present? %>
          <div class="alert alert-warning py-2 small mb-3">
            <strong>Static token</strong> &mdash; using <code>AUTHENTIK_API_TOKEN</code>. Set <code>AUTHENTIK_CLIENT_ID</code>, <code>AUTHENTIK_CLIENT_SECRET</code>, and <code>AUTHENTIK_ISSUER</code> to enable automatic token refresh.
          </div>
        <% else %>
          <div class="alert alert-danger py-2 small mb-3">
            <strong>No API token configured.</strong> Set OAuth credentials or <code>AUTHENTIK_API_TOKEN</code>.
          </div>
        <% end %>

        <h6>Required Environment Variables</h6>
        <ul class="small">
          <li>
            <code>MEMBER_MANAGER_BASE_URL</code>
            <% if @member_manager_base_url.present? %>
              <span class="badge text-bg-success">Set</span>
            <% else %>
              <span class="badge text-bg-danger">Missing</span>
            <% end %>
          </li>
          <li>
            <code>AUTHENTIK_API_TOKEN</code>
            <% if AuthentikConfig.settings.api_token.present? %>
              <span class="badge text-bg-success">Set</span>
            <% elsif Authentik::TokenManager.oauth_configured? %>
              <span class="badge text-bg-info">Not needed (OAuth)</span>
            <% else %>
              <span class="badge text-bg-danger">Missing</span>
            <% end %>
          </li>
          <li>
            <code>AUTHENTIK_GROUP_ID</code>
            <% if AuthentikConfig.settings.group_id.present? %>
              <span class="badge text-bg-success">Set</span>
            <% else %>
              <span class="badge text-bg-warning">Optional</span>
            <% end %>
          </li>
        </ul>

        <h6 class="mt-4">Optional Environment Variables</h6>
        <ul class="small">
          <li><code>AUTHENTIK_WEBHOOK_SECRET</code> - Secret for webhook authentication</li>
          <li><code>AUTHENTIK_TOKEN_ENDPOINT</code> - Override OIDC-discovered token endpoint</li>
        </ul>

        <h6 class="mt-4">Group Sync</h6>
        <p class="small text-muted">
          Set <strong>Authentik Group ID</strong> on Application Groups to sync their events.
        </p>
        <%= link_to "Manage Applications", applications_path, class: "btn btn-outline-secondary btn-sm w-100 mb-3" %>

        <h6 class="mt-4">Rake Tasks</h6>
        <ul class="small">
          <li><code>rails authentik:webhooks:setup</code></li>
          <li><code>rails authentik:webhooks:status</code></li>
          <li><code>rails authentik:webhooks:teardown</code></li>
        </ul>
      </div>
    </div>
  </div>
</div>
