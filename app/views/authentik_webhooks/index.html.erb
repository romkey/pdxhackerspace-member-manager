<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="h3 mb-0">Authentik Webhooks</h1>
  <%= link_to "&larr; Back to Settings".html_safe, settings_path, class: "text-decoration-none" %>
</div>

<div class="row">
  <div class="col-lg-8">
    <div class="card shadow-sm border-0 mb-4">
      <div class="card-header bg-body-tertiary">
        <h5 class="mb-0">Webhook Configuration Status</h5>
      </div>
      <div class="card-body">
        <% if @status[:configured] %>
          <div class="alert alert-success mb-4">
            <i class="bi bi-check-circle me-2"></i>
            <strong>Webhooks are configured</strong>
          </div>

          <dl class="row mb-0">
            <dt class="col-sm-4">Transport</dt>
            <dd class="col-sm-8">
              <code><%= @status[:transport][:name] %></code>
              <span class="text-muted small ms-2">(<%= @status[:transport][:id] %>)</span>
            </dd>

            <dt class="col-sm-4">Webhook URL</dt>
            <dd class="col-sm-8">
              <code class="text-break"><%= @status[:transport][:webhook_url]&.gsub(/secret=[^&]+/, 'secret=***') %></code>
            </dd>

            <% if @status[:user_policy] %>
              <dt class="col-sm-4">User Policy</dt>
              <dd class="col-sm-8">
                <code><%= @status[:user_policy][:name] %></code>
              </dd>
            <% end %>

            <% if @status[:group_policy] %>
              <dt class="col-sm-4">Group Policy</dt>
              <dd class="col-sm-8">
                <code><%= @status[:group_policy][:name] %></code>
              </dd>
            <% end %>

            <dt class="col-sm-4">Notification Rule</dt>
            <dd class="col-sm-8">
              <code><%= @status[:rule][:name] %></code>
            </dd>
          </dl>

          <hr class="my-4">

          <div class="d-flex gap-2">
            <%= button_to "Reconfigure Webhooks", setup_authentik_webhooks_path, 
                method: :post, 
                class: "btn btn-outline-primary",
                data: { turbo_confirm: "This will update the webhook configuration. Continue?" } %>
            <%= button_to "Remove Configuration", teardown_authentik_webhooks_path, 
                method: :delete, 
                class: "btn btn-outline-danger",
                data: { turbo_confirm: "This will remove all webhook configuration from Authentik. Continue?" } %>
          </div>
        <% else %>
          <div class="alert alert-warning mb-4">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Webhooks are not configured</strong>
          </div>

          <p class="text-muted">
            Configure Authentik to send webhook notifications when users or groups change.
            This enables real-time synchronization of member data.
          </p>

          <% if @member_manager_base_url.blank? %>
            <div class="alert alert-danger">
              <i class="bi bi-x-circle me-2"></i>
              <strong>Missing configuration:</strong> Set the <code>MEMBER_MANAGER_BASE_URL</code> environment variable
              to your MemberManager public URL (e.g., <code>https://members.example.org</code>).
            </div>
          <% else %>
            <%= button_to "Set Up Webhooks", setup_authentik_webhooks_path, 
                method: :post, 
                class: "btn btn-primary",
                data: { turbo_confirm: "This will create webhook configuration in Authentik. Continue?" } %>
          <% end %>
        <% end %>
      </div>
    </div>

    <div class="card shadow-sm border-0">
      <div class="card-header bg-body-tertiary">
        <h5 class="mb-0">Group Filtering</h5>
      </div>
      <div class="card-body">
        <p class="text-muted">
          By default, all user and group events are processed. You can filter to only process events
          for specific groups by setting the <code>AUTHENTIK_SYNCED_GROUP_IDS</code> environment variable.
        </p>

        <% if @synced_group_ids.present? %>
          <div class="alert alert-info mb-0">
            <strong>Filtering active:</strong> Only processing events for these groups:
            <ul class="mb-0 mt-2">
              <% @synced_group_ids.each do |group_id| %>
                <li><code><%= group_id %></code></li>
              <% end %>
            </ul>
          </div>
        <% else %>
          <div class="alert alert-secondary mb-0">
            <strong>No filter configured:</strong> All group events will be processed.
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card shadow-sm border-0">
      <div class="card-header bg-body-tertiary">
        <h5 class="mb-0">Configuration</h5>
      </div>
      <div class="card-body">
        <h6>Required Environment Variables</h6>
        <ul class="small">
          <li>
            <code>MEMBER_MANAGER_BASE_URL</code>
            <% if @member_manager_base_url.present? %>
              <span class="badge text-bg-success">Set</span>
            <% else %>
              <span class="badge text-bg-danger">Missing</span>
            <% end %>
          </li>
          <li>
            <code>AUTHENTIK_API_TOKEN</code>
            <% if AuthentikConfig.settings.api_token.present? %>
              <span class="badge text-bg-success">Set</span>
            <% else %>
              <span class="badge text-bg-danger">Missing</span>
            <% end %>
          </li>
          <li>
            <code>AUTHENTIK_GROUP_ID</code>
            <% if AuthentikConfig.settings.group_id.present? %>
              <span class="badge text-bg-success">Set</span>
            <% else %>
              <span class="badge text-bg-warning">Optional</span>
            <% end %>
          </li>
        </ul>

        <h6 class="mt-4">Optional Environment Variables</h6>
        <ul class="small">
          <li><code>AUTHENTIK_WEBHOOK_SECRET</code> - Secret for webhook authentication</li>
          <li><code>AUTHENTIK_SYNCED_GROUP_IDS</code> - Comma-separated list of group IDs to sync</li>
        </ul>

        <h6 class="mt-4">Rake Tasks</h6>
        <ul class="small">
          <li><code>rails authentik:webhooks:setup</code></li>
          <li><code>rails authentik:webhooks:status</code></li>
          <li><code>rails authentik:webhooks:teardown</code></li>
        </ul>
      </div>
    </div>
  </div>
</div>
