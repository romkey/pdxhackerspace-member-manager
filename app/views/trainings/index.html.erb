<div class="py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">Train a Member</h1>
    <%= link_to "&larr; Dashboard".html_safe, root_path, class: "text-decoration-none" %>
  </div>

  <% if @trainable_topics.empty? %>
    <div class="alert alert-warning">
      <i class="bi bi-exclamation-triangle me-2"></i>
      No training topics are available. <% if current_user_admin? %>Please create some training topics first.<% end %>
    </div>
  <% else %>
    <div class="row">
      <!-- Member Search -->
      <div class="col-lg-5 mb-4">
        <div class="card shadow-sm border-0">
          <div class="card-header bg-body-tertiary">
            <h5 class="mb-0"><i class="bi bi-search me-2"></i>Find a Member</h5>
          </div>
          <div class="card-body">
            <input type="text" id="training_member_search" class="form-control form-control-lg" 
                   placeholder="Type to search by name, email, or username..." autocomplete="off">
            <div id="training_search_results" class="mt-2 d-none" style="max-height: 400px; overflow-y: auto;">
              <% @users_for_search.each do |user| %>
                <a href="<%= train_member_path(user_id: user.id) %>" 
                   class="search-result-item d-none d-block p-3 text-decoration-none border-bottom <%= 'bg-primary-subtle border-primary' if params[:user_id].to_i == user.id %>"
                   data-search-text="<%= [user.display_name, user.email, user.username].compact.join(' ').downcase %>"
                   data-user-id="<%= user.id %>">
                  <div class="fw-semibold"><%= user.display_name %></div>
                  <% if user.email.present? %>
                    <div class="text-muted small"><%= user.email %></div>
                  <% end %>
                </a>
              <% end %>
            </div>
            <div id="training_no_results" class="mt-2 p-3 text-center text-muted border rounded d-none">
              No members found matching your search.
            </div>
          </div>
        </div>
      </div>

      <!-- Training Topics Management -->
      <div class="col-lg-7 mb-4">
        <% if params[:user_id].present? %>
          <% selected_user = User.find_by(id: params[:user_id]) %>
          <% if selected_user %>
            <div class="card shadow-sm border-0">
              <div class="card-header bg-body-tertiary d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                  <i class="bi bi-mortarboard me-2"></i>
                  Training for <%= selected_user.display_name %>
                </h5>
                <%= link_to user_path(selected_user), class: "btn btn-outline-secondary btn-sm" do %>
                  <i class="bi bi-person"></i> View Profile
                <% end %>
              </div>
              <div class="card-body">
                <% trained_topic_ids = selected_user.trainings_as_trainee.pluck(:training_topic_id).uniq %>
                
                <% if @trainable_topics.any? %>
                  <div class="mb-3">
                    <label class="form-label fw-semibold text-muted small">
                      <% if current_user_admin? %>
                        All Topics (Admin)
                      <% else %>
                        Topics You Can Train
                      <% end %>
                    </label>
                  </div>

                  <div class="d-flex flex-wrap gap-2">
                    <% @trainable_topics.each do |topic| %>
                      <% is_trained = trained_topic_ids.include?(topic.id) %>
                      <div class="d-inline-flex align-items-center border rounded px-3 py-2 <%= is_trained ? 'bg-success-subtle border-success' : 'bg-body-secondary' %>">
                        <%= link_to topic.name, edit_training_topic_path(topic), class: "me-2 text-decoration-none" %>
                        <% if is_trained %>
                          <%= button_to remove_training_path(user_id: selected_user.id, topic_id: topic.id), 
                              method: :delete,
                              class: "btn btn-sm btn-outline-danger ms-1",
                              title: "Remove training",
                              data: { turbo_confirm: "Remove #{topic.name} training from #{selected_user.display_name}?" } do %>
                            <i class="bi bi-x-lg"></i>
                          <% end %>
                        <% else %>
                          <%= button_to add_training_path(user_id: selected_user.id, topic_id: topic.id), 
                              method: :post,
                              class: "btn btn-sm btn-outline-success ms-1",
                              title: "Add training" do %>
                            <i class="bi bi-plus-lg"></i>
                          <% end %>
                        <% end %>
                      </div>
                    <% end %>
                  </div>

                  <% # Show topics the user is trained in but the trainer can't modify %>
                  <% non_trainable_trained_ids = trained_topic_ids - @trainable_topics.pluck(:id) %>
                  <% if non_trainable_trained_ids.any? %>
                    <hr class="my-4">
                    <div class="mb-3">
                      <label class="form-label fw-semibold text-muted small">
                        Other Training (View Only)
                      </label>
                    </div>
                    <div class="d-flex flex-wrap gap-2">
                      <% TrainingTopic.where(id: non_trainable_trained_ids).order(:name).each do |topic| %>
                        <%= link_to topic.name, edit_training_topic_path(topic), class: "badge text-bg-primary fs-6 px-3 py-2 text-decoration-none" %>
                      <% end %>
                    </div>
                  <% end %>
                <% end %>

                <% # Trainer capabilities (admin only) %>
                <% if current_user_admin? %>
                  <hr class="my-4">
                  <div class="mb-3">
                    <label class="form-label fw-semibold text-muted small">
                      <i class="bi bi-person-badge me-1"></i>Can Train Others In (Admin Only)
                    </label>
                  </div>
                  <% trainer_topic_ids = selected_user.training_topics.pluck(:id) %>
                  <% all_topics = TrainingTopic.order(:name) %>
                  <div class="d-flex flex-wrap gap-2">
                    <% all_topics.each do |topic| %>
                      <% is_trainer = trainer_topic_ids.include?(topic.id) %>
                      <div class="d-inline-flex align-items-center border rounded px-3 py-2 <%= is_trainer ? 'bg-info-subtle border-info' : 'bg-body-secondary' %>">
                        <%= link_to topic.name, edit_training_topic_path(topic), class: "me-2 text-decoration-none" %>
                        <% if is_trainer %>
                          <%= button_to remove_trainer_capability_path(user_id: selected_user.id, topic_id: topic.id), 
                              method: :delete,
                              class: "btn btn-sm btn-outline-danger ms-1",
                              title: "Remove trainer capability",
                              data: { turbo_confirm: "Remove #{topic.name} trainer capability from #{selected_user.display_name}?" } do %>
                            <i class="bi bi-x-lg"></i>
                          <% end %>
                        <% else %>
                          <%= button_to add_trainer_capability_path(user_id: selected_user.id, topic_id: topic.id), 
                              method: :post,
                              class: "btn btn-sm btn-outline-info ms-1",
                              title: "Grant trainer capability" do %>
                            <i class="bi bi-plus-lg"></i>
                          <% end %>
                        <% end %>
                      </div>
                    <% end %>
                  </div>
                <% end %>

                <% # Training history %>
                <% trainings = selected_user.trainings_as_trainee.includes(:training_topic, :trainer).order(trained_at: :desc).limit(10) %>
                <% if trainings.any? %>
                  <hr class="my-4">
                  <h6 class="text-muted mb-3">Recent Training History</h6>
                  <div class="table-responsive">
                    <table class="table table-sm mb-0">
                      <thead class="bg-body-tertiary">
                        <tr>
                          <th>Topic</th>
                          <th>Trained By</th>
                          <th>Date</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% trainings.each do |training| %>
                          <tr>
                            <td><%= link_to training.training_topic.name, edit_training_topic_path(training.training_topic), class: "badge text-bg-primary text-decoration-none" %></td>
                            <td>
                              <% if training.trainer %>
                                <%= link_to training.trainer.display_name, user_path(training.trainer), class: "text-decoration-none" %>
                              <% else %>
                                <span class="text-muted fst-italic">Unknown</span>
                              <% end %>
                            </td>
                            <td><%= training.trained_at.strftime('%Y-%m-%d') %></td>
                          </tr>
                        <% end %>
                      </tbody>
                    </table>
                  </div>
                <% end %>
              </div>
            </div>
          <% else %>
            <div class="alert alert-warning">
              <i class="bi bi-exclamation-triangle me-2"></i>
              Member not found. Please search for a member.
            </div>
          <% end %>
        <% else %>
          <div class="card shadow-sm border-0 h-100">
            <div class="card-body d-flex align-items-center justify-content-center text-center">
              <div class="py-5">
                <i class="bi bi-arrow-left display-4 text-muted mb-3 d-block"></i>
                <h5 class="text-muted">Search for a member to manage their training</h5>
                <p class="text-muted small mb-0">
                  You can train members in 
                  <% if current_user_admin? %>
                    <strong>all topics</strong> (Admin)
                  <% else %>
                    <strong><%= @trainable_topics.map(&:name).join(', ') %></strong>
                  <% end %>
                </p>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
</div>

<script>
  // Training member search
  (function() {
    var searchInput = document.getElementById('training_member_search');
    var searchResults = document.getElementById('training_search_results');
    var noResults = document.getElementById('training_no_results');
    
    if (!searchInput || !searchResults) return;
    
    var results = searchResults.querySelectorAll('.search-result-item');
    
    function doFilter() {
      var searchTerm = searchInput.value.toLowerCase().trim();
      var visibleCount = 0;

      if (searchTerm === '' || searchTerm.length < 2) {
        searchResults.classList.add('d-none');
        noResults.classList.add('d-none');
        // Hide all results
        for (var i = 0; i < results.length; i++) {
          results[i].classList.add('d-none');
        }
        return;
      }

      for (var i = 0; i < results.length; i++) {
        var result = results[i];
        var text = result.getAttribute('data-search-text');
        if (text && text.indexOf(searchTerm) !== -1) {
          result.classList.remove('d-none');
          visibleCount++;
        } else {
          result.classList.add('d-none');
        }
      }

      if (visibleCount === 0) {
        searchResults.classList.add('d-none');
        noResults.classList.remove('d-none');
      } else {
        searchResults.classList.remove('d-none');
        noResults.classList.add('d-none');
      }
    }

    searchInput.addEventListener('input', doFilter);
    searchInput.addEventListener('keyup', doFilter);
  })();
</script>
