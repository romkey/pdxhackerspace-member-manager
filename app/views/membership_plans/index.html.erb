<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="h3 mb-0">Membership Plans</h1>
  <%= link_to "&larr; Back to Settings".html_safe, settings_path, class: "text-decoration-none" %>
</div>

<div class="card shadow-sm border-0 mb-4">
  <div class="card-body">
    <h2 class="h5 mb-3">Add New Membership Plan</h2>
    <% if @membership_plan&.errors&.any? %>
      <div class="alert alert-danger">
        <ul class="mb-0">
          <% @membership_plan.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>
    <%= form_with model: @membership_plan, url: membership_plans_path, local: true, class: "row g-3" do |f| %>
      <div class="col-md-4">
        <%= f.text_field :name, class: "form-control #{'is-invalid' if @membership_plan&.errors&.key?(:name)}", placeholder: "Plan name", required: true %>
        <% if @membership_plan&.errors&.key?(:name) %>
          <div class="invalid-feedback">
            <%= @membership_plan.errors[:name].first %>
          </div>
        <% end %>
      </div>
      <div class="col-md-2">
        <%= f.number_field :cost, step: 0.01, min: 0, class: "form-control #{'is-invalid' if @membership_plan&.errors&.key?(:cost)}", placeholder: "Cost", required: true %>
        <% if @membership_plan&.errors&.key?(:cost) %>
          <div class="invalid-feedback">
            <%= @membership_plan.errors[:cost].first %>
          </div>
        <% end %>
      </div>
      <div class="col-md-3">
        <%= f.select :billing_frequency, 
            options_for_select([['Monthly', 'monthly'], ['Yearly', 'yearly'], ['One-time', 'one-time']], @membership_plan&.billing_frequency),
            { prompt: 'Select frequency' },
            { class: "form-select #{'is-invalid' if @membership_plan&.errors&.key?(:billing_frequency)}", required: true } %>
        <% if @membership_plan&.errors&.key?(:billing_frequency) %>
          <div class="invalid-feedback">
            <%= @membership_plan.errors[:billing_frequency].first %>
          </div>
        <% end %>
      </div>
      <div class="col-md-3">
        <%= f.select :plan_type, 
            options_for_select([['Primary', 'primary'], ['Supplementary', 'supplementary']], @membership_plan&.plan_type || 'primary'),
            {},
            { class: "form-select" } %>
      </div>
      <div class="col-md-6">
        <%= f.text_area :description, class: "form-control", placeholder: "Description (optional)", rows: 2 %>
      </div>
      <div class="col-md-6">
        <%= f.url_field :payment_link, class: "form-control", placeholder: "Payment link URL (optional)" %>
      </div>
      <div class="col-md-6">
        <%= f.text_field :paypal_transaction_subject, class: "form-control", placeholder: "PayPal transaction subject (optional)" %>
        <div class="form-text">Used to match PayPal payments to this plan (e.g., "Storage Space").</div>
      </div>
      <div class="col-md-3">
        <div class="form-check mt-2">
          <%= f.check_box :manual, class: "form-check-input" %>
          <%= f.label :manual, "Manual", class: "form-check-label" %>
        </div>
        <div class="form-text">Dues are collected manually (cash, check, etc.)</div>
      </div>
      <div class="col-md-3">
        <div class="form-check mt-2">
          <%= f.check_box :visible, class: "form-check-input", checked: @membership_plan&.visible.nil? ? true : @membership_plan.visible %>
          <%= f.label :visible, "Visible to Members", class: "form-check-label" %>
        </div>
        <div class="form-text">Show this plan to non-admin members</div>
      </div>
      <div class="col-md-6 d-flex align-items-end">
        <%= f.submit "Add Plan", class: "btn btn-primary" %>
      </div>
    <% end %>
  </div>
</div>

<div class="card shadow-sm border-0">
  <div class="card-body">
    <h2 class="h5 mb-3">Membership Plans</h2>
    <% if @membership_plans.any? %>
      <div class="accordion" id="membershipPlansAccordion">
        <% @membership_plans.each_with_index do |plan, index| %>
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#plan-<%= plan.id %>" aria-expanded="false" aria-controls="plan-<%= plan.id %>">
                <div class="d-flex align-items-center gap-3 flex-wrap">
                  <strong><%= plan.name %></strong>
                  <% if plan.primary? %>
                    <span class="badge text-bg-primary">Primary</span>
                  <% else %>
                    <span class="badge text-bg-info">Supplementary</span>
                  <% end %>
                  <span class="text-muted">$<%= format('%.2f', plan.cost) %>/<%= plan.billing_frequency %></span>
                  <% member_count = plan.primary? ? plan.users.count : plan.supplementary_users.count %>
                  <span class="badge text-bg-secondary"><%= member_count %> member<%= member_count == 1 ? '' : 's' %></span>
                  <% if plan.manual? %>
                    <span class="badge text-bg-warning">Manual</span>
                  <% end %>
                  <% unless plan.visible? %>
                    <span class="badge text-bg-dark">Hidden</span>
                  <% end %>
                </div>
              </button>
            </h2>
            <div id="plan-<%= plan.id %>" class="accordion-collapse collapse" data-bs-parent="#membershipPlansAccordion">
              <div class="accordion-body">
                <div class="row">
                  <div class="col-md-6">
                    <h6 class="text-muted mb-2">Plan Details</h6>
                    <dl class="row mb-0 small">
                      <dt class="col-sm-4">Type</dt>
                      <dd class="col-sm-8">
                        <% if plan.primary? %>
                          <span class="badge text-bg-primary">Primary</span>
                        <% else %>
                          <span class="badge text-bg-info">Supplementary</span>
                        <% end %>
                      </dd>

                      <dt class="col-sm-4">Cost</dt>
                      <dd class="col-sm-8">$<%= format('%.2f', plan.cost) %></dd>
                      
                      <dt class="col-sm-4">Frequency</dt>
                      <dd class="col-sm-8"><span class="badge text-bg-secondary"><%= plan.billing_frequency.humanize %></span></dd>
                      
                      <dt class="col-sm-4">Payment Link</dt>
                      <dd class="col-sm-8">
                        <% if plan.payment_link.present? %>
                          <%= link_to truncate(plan.payment_link, length: 40), plan.payment_link, target: "_blank", rel: "noopener" %>
                        <% else %>
                          <span class="text-muted fst-italic">Not set</span>
                        <% end %>
                      </dd>

                      <dt class="col-sm-4">PayPal Subject</dt>
                      <dd class="col-sm-8">
                        <% if plan.paypal_transaction_subject.present? %>
                          <code><%= plan.paypal_transaction_subject %></code>
                        <% else %>
                          <span class="text-muted fst-italic">Not set</span>
                        <% end %>
                      </dd>

                      <dt class="col-sm-4">Manual</dt>
                      <dd class="col-sm-8">
                        <% if plan.manual? %>
                          <span class="badge text-bg-warning">Yes</span>
                        <% else %>
                          <span class="text-muted">No</span>
                        <% end %>
                      </dd>

                      <dt class="col-sm-4">Visible</dt>
                      <dd class="col-sm-8">
                        <% if plan.visible? %>
                          <span class="text-muted">Yes</span>
                        <% else %>
                          <span class="badge text-bg-dark">Hidden</span>
                        <% end %>
                      </dd>
                      
                      <% if plan.description.present? %>
                        <dt class="col-sm-4">Description</dt>
                        <dd class="col-sm-8"><%= sanitize(plan.description, tags: %w[p br strong b em i u s ul ol li a], attributes: %w[href target]) %></dd>
                      <% end %>
                    </dl>
                  </div>
                  <div class="col-md-6">
                    <% plan_users = plan.primary? ? plan.users : plan.supplementary_users %>
                    <h6 class="text-muted mb-2">Members on this Plan (<%= plan_users.count %>)</h6>
                    <% if plan_users.any? %>
                      <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm table-hover mb-0">
                          <thead class="bg-body-tertiary sticky-top">
                            <tr>
                              <th>Name</th>
                              <th>Status</th>
                              <th>Dues</th>
                            </tr>
                          </thead>
                          <tbody>
                            <% plan_users.order(Arel.sql('COALESCE(full_name, username)')).each do |user| %>
                              <tr>
                                <td>
                                  <%= link_to user.display_name, user_path(user), class: "text-decoration-none" %>
                                </td>
                                <td>
                                  <% if user.active? %>
                                    <span class="badge text-bg-success">Active</span>
                                  <% else %>
                                    <span class="badge text-bg-secondary">Inactive</span>
                                  <% end %>
                                </td>
                                <td>
                                  <% dues_badge_class = case user.dues_status
                                     when "current" then "success"
                                     when "lapsed" then "warning"
                                     else "secondary"
                                     end %>
                                  <span class="badge text-bg-<%= dues_badge_class %>"><%= user.dues_status.humanize %></span>
                                </td>
                              </tr>
                            <% end %>
                          </tbody>
                        </table>
                      </div>
                    <% else %>
                      <p class="text-muted fst-italic mb-0">No members on this plan yet.</p>
                    <% end %>
                  </div>
                </div>
                <hr class="my-3">
                <div class="d-flex justify-content-end gap-2">
                  <%= link_to "Edit", edit_membership_plan_path(plan), class: "btn btn-outline-primary" %>
                  <% plan_users = plan.primary? ? plan.users : plan.supplementary_users %>
                  <% if plan_users.any? %>
                    <button type="button" class="btn btn-outline-danger" disabled 
                            title="Cannot delete: <%= plan_users.count %> member<%= plan_users.count == 1 ? ' is' : 's are' %> using this plan">
                      Delete
                    </button>
                  <% else %>
                    <%= button_to "Delete", membership_plan_path(plan), method: :delete, 
                        class: "btn btn-outline-danger",
                        data: { turbo_confirm: "Are you sure you want to delete '#{plan.name}'?" } %>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="text-muted mb-0">No membership plans yet. Add one above to get started.</p>
    <% end %>
  </div>
</div>

