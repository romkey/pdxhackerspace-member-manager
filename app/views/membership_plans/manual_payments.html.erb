<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h3 mb-1">Manual Payment Plan Members</h1>
    <p class="text-muted mb-0">Members on payment plans that require manual dues collection</p>
  </div>
  <div class="d-flex gap-2">
    <%= link_to "Back to Dashboard", root_path, class: "btn btn-outline-secondary" %>
  </div>
</div>

<% if @members.any? %>
  <div class="card shadow-sm border-0">
    <div class="table-responsive">
      <table class="table mb-0 align-middle">
        <thead class="bg-body-tertiary">
          <tr>
            <th scope="col">Member</th>
            <th scope="col">Plan</th>
            <th scope="col">Amount</th>
            <th scope="col">Dues Status</th>
            <th scope="col">Next Due</th>
            <th scope="col" class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% @members.each do |m| %>
            <% user = m[:user] %>
            <% plan = m[:plan] %>
            <% next_date = m[:next_payment_date] %>
            <% near_due = m[:near_due] %>
            <tr class="<%= 'table-warning' if near_due %>">
              <td>
                <%= link_to user.display_name, user_path(user), class: "fw-semibold text-decoration-none" %>
                <% if user.email.present? %>
                  <br><small class="text-muted"><%= user.email %></small>
                <% end %>
              </td>
              <td>
                <span class="badge text-bg-warning">Manual</span>
                <%= plan.name %>
              </td>
              <td>
                <strong>$<%= format('%.2f', plan.cost) %></strong>
                <span class="text-muted">/ <%= plan.billing_frequency %></span>
              </td>
              <td>
                <% dues_badge = case user.dues_status
                   when 'current' then 'success'
                   when 'lapsed' then 'warning'
                   else 'secondary'
                   end %>
                <span class="badge text-bg-<%= dues_badge %>"><%= user.dues_status.humanize %></span>
              </td>
              <td>
                <% if next_date.present? %>
                  <% if next_date <= Date.current %>
                    <span class="text-danger fw-bold"><%= next_date.strftime('%b %d, %Y') %></span>
                    <br><small class="text-danger">Overdue</small>
                  <% elsif near_due %>
                    <span class="text-warning fw-bold"><%= next_date.strftime('%b %d, %Y') %></span>
                    <br><small class="text-warning">Due soon</small>
                  <% else %>
                    <%= next_date.strftime('%b %d, %Y') %>
                  <% end %>
                <% else %>
                  <span class="text-muted">Unknown</span>
                <% end %>
              </td>
              <td class="text-end">
                <% if near_due || (next_date.present? && next_date <= Date.current) || next_date.nil? %>
                  <%= button_to "Mark Dues Received",
                      mark_dues_received_membership_plans_path(user_id: user.id),
                      method: :post,
                      class: "btn btn-success btn-sm",
                      data: { turbo_confirm: "Mark dues received for #{user.display_name}?" } %>
                <% else %>
                  <button class="btn btn-outline-secondary btn-sm" disabled
                          title="Not yet near due date">
                    Mark Dues Received
                  </button>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
<% else %>
  <div class="card shadow-sm border-0">
    <div class="card-body text-center py-5">
      <i class="bi bi-cash-coin display-4 text-muted mb-3 d-block"></i>
      <p class="text-muted mb-0">No members are on manual payment plans.</p>
    </div>
  </div>
<% end %>
