<div class="row justify-content-center py-5">
  <div class="col-12 col-md-7 col-lg-5">
    <div class="card shadow-sm border-0">
      <div class="card-body p-4">
        <h1 class="h4 mb-3 text-center">Waiting for Keyfob Scan</h1>
        
        <div class="text-center mb-4">
          <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>

        <p class="text-center text-muted mb-4">
          Use the keyfob reader on the middle table in Section 2.
        </p>

        <div class="text-center">
          <%= link_to "Cancel", login_path, class: "btn btn-outline-secondary" %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Poll for webhook data every 2 seconds
  let checkInterval;
  
  function checkWebhook() {
    fetch('<%= rfid_check_webhook_path %>', {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'ready') {
        // Webhook received, redirect to verification page
        clearInterval(checkInterval);
        window.location.href = '<%= rfid_verify_path %>';
      } else if (data.status === 'no_session') {
        // Session expired, redirect to login
        clearInterval(checkInterval);
        window.location.href = '<%= login_path %>';
      }
    })
    .catch(error => {
      console.error('Error checking webhook:', error);
    });
  }

  // Start polling when page loads
  document.addEventListener('DOMContentLoaded', function() {
    checkInterval = setInterval(checkWebhook, 2000);
    // Also check immediately
    checkWebhook();
  });

  // Clean up interval when leaving page
  window.addEventListener('beforeunload', function() {
    if (checkInterval) {
      clearInterval(checkInterval);
    }
  });
</script>

